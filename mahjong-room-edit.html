<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>PO・TORO｜面子募集 部屋を編集</title>
<meta name="theme-color" content="#f6b7d2" />
<style>
:root{
  --bg:#fff7fb;--ink:#2b2b2b;--sub:#666;
  --accent:#ff79a6;--accent2:#7fc9ff;--ring:#ffd7e6;
  --shadow:0 12px 28px rgba(0,0,0,.08);
  --radius:22px;--danger:#ff5b6a;--ok:#2ecc71;
  --card:rgba(255,255,255,.92);--line:rgba(0,0,0,.08);
}
*{box-sizing:border-box}
html,body{height:100%}
body{
  margin:0;
  font-family:"Hiragino Kaku Gothic ProN","Noto Sans JP",system-ui;
  background:
    radial-gradient(1200px 600px at 15% 10%, rgba(255,121,166,.14), transparent 55%),
    radial-gradient(900px 500px at 85% 20%, rgba(127,201,255,.16), transparent 60%),
    linear-gradient(180deg,var(--bg),#fff);
  color:var(--ink)
}
a{color:inherit;text-decoration:none}
a:focus-visible,button:focus-visible,input:focus-visible,textarea:focus-visible{
  outline:3px solid rgba(255,121,166,.35);
  outline-offset:3px;
  border-radius:14px;
}
.wrap{max-width:760px;margin:0 auto;padding:18px 14px 28px}
header{display:flex;justify-content:space-between;align-items:flex-end;gap:10px;flex-wrap:wrap;margin-bottom:14px}
h1{margin:0;font-size:20px}
.sub{margin-top:6px;font-size:12px;color:var(--sub);line-height:1.6}
.badge{
  font-size:12px;padding:7px 10px;border-radius:999px;background:rgba(255,255,255,.75);
  border:1px solid rgba(255,121,166,.22);color:#b34a6a;white-space:nowrap
}
.card{
  background:var(--card);
  border:1px solid rgba(0,0,0,.06);
  border-radius:var(--radius);
  padding:14px;
  box-shadow:0 10px 22px rgba(0,0,0,.06);
}
.row{display:flex;gap:10px;flex-wrap:wrap}
.kv{display:flex;flex-direction:column;gap:6px;flex:1 1 240px}
label{font-size:12px;font-weight:1000;color:#5d5258}
input,textarea{
  padding:12px;border-radius:14px;border:1px solid #ddd;
  font-size:14px;font-family:inherit;background:#fff
}
textarea{min-height:92px;resize:vertical}
.help{font-size:12px;color:#7a6a70;line-height:1.6;margin-top:6px}
.hr{border:none;border-top:1px dashed rgba(0,0,0,.12);margin:12px 0}
.btns{display:flex;gap:10px;flex-wrap:wrap;justify-content:flex-end;margin-top:12px}
.btn{
  padding:10px 12px;border-radius:14px;border:1px solid rgba(255,121,166,.25);
  background:#fff;font-weight:1000;cursor:pointer;
  transition:transform .08s ease, box-shadow .15s ease, border-color .15s ease;
  box-shadow:0 10px 22px rgba(0,0,0,.05);
}
.btn:hover{transform:translateY(-1px); box-shadow:0 14px 24px rgba(0,0,0,.08); border-color:rgba(255,121,166,.35)}
.btn:active{transform:translateY(0)}
.btn.primary{border:none;color:#fff;background:linear-gradient(135deg,var(--accent),var(--accent2))}
.btn.ghost{border-color:rgba(0,0,0,.10)}
.btn.danger{border-color:rgba(255,91,106,.35);color:#a51d2c;background:rgba(255,91,106,.08)}
.pill{
  display:inline-flex;align-items:center;
  font-size:12px;font-weight:1000;
  padding:6px 10px;border-radius:999px;
  background:rgba(127,201,255,.12);
  border:1px solid rgba(127,201,255,.25);
  color:#2b4a62;
}
.notice{
  font-size:12px;line-height:1.7;color:#6b5f66;
  border:1px solid rgba(0,0,0,.06);
  background:rgba(255,255,255,.75);
  padding:10px 12px;border-radius:16px;
}
.notice.warn{
  border-color:rgba(255,91,106,.18);
  background:rgba(255,91,106,.08);
  color:#8a4b55;
}
.hidden{display:none !important}
</style>
</head>

<body>
<div class="wrap">
  <header>
    <div>
      <h1>部屋を編集</h1>
      <div class="sub">編集には <span class="pill">削除キー（4桁）</span> が必要です。</div>
    </div>
    <div class="badge">PO・TORO / Mahjong</div>
  </header>

  <!-- ① ガード（キー入力） -->
  <div id="gate" class="card">
    <div class="notice">
      対象部屋：<b id="roomIdView">—</b><br>
      削除キー（4桁）を入力して認証してください。
    </div>
    <div class="hr"></div>
    <div class="row">
      <div class="kv" style="flex:1 1 220px">
        <label for="gateKey">削除キー（4桁）</label>
        <input id="gateKey" type="password" inputmode="numeric" maxlength="4" placeholder="4桁の数字" autocomplete="off" />
        <div class="help">※キーは Firestore の <b>deleteKeyHash</b> と照合します。</div>
      </div>
    </div>
    <div class="btns">
      <button class="btn ghost" type="button" id="btnBack">部屋一覧へ戻る</button>
      <button class="btn primary" type="button" id="btnVerify">認証して編集へ</button>
    </div>
    <div id="gateMsg" class="notice warn hidden" style="margin-top:12px"></div>
  </div>

  <!-- ② 編集フォーム -->
  <div id="editor" class="card hidden" aria-live="polite">
    <div class="notice">
      対象部屋：<b id="roomIdView2">—</b><br>
      保存すると即時反映されます。
    </div>
    <div class="hr"></div>

    <div class="row">
      <div class="kv">
        <label>作成者</label>
        <input id="creatorName" readonly />
      </div>
      <div class="kv">
        <label>形式</label>
        <input id="rule" readonly />
      </div>
    </div>

    <div class="row" style="margin-top:10px">
      <div class="kv">
        <label>開始</label>
        <input id="eventAt" readonly />
      </div>
      <div class="kv">
        <label>終了</label>
        <input id="endAt" readonly />
      </div>
    </div>

    <div class="hr"></div>

    <div class="row">
      <div class="kv">
        <label for="comment">ひとこと（comment）</label>
        <textarea id="comment" maxlength="120" placeholder="例：お屋敷でゆるっと打ちましょう！"></textarea>
        <div class="help">最大120文字。空でもOK。</div>
      </div>
    </div>

    <div class="row" style="margin-top:10px">
      <div class="kv" style="flex:1 1 180px">
        <label for="slotsTotal">募集人数（slotsTotal）</label>
        <input id="slotsTotal" type="number" min="1" max="20" step="1" />
        <div class="help">参加数（joinedCount）未満にはできません。</div>
      </div>

      <div class="kv" style="flex:1 1 240px">
        <label for="deadlineLocal">締切（deadlineAt）</label>
        <input id="deadlineLocal" type="datetime-local" />
        <div class="help">現在時刻を過ぎると自動で締切扱いになります。</div>
      </div>
    </div>

    <div class="row" style="margin-top:10px">
      <div class="kv" style="flex:1 1 220px">
        <label for="closed">締切フラグ（closed）</label>
        <input id="closed" type="checkbox" />
        <div class="help">ONにすると強制締切。OFFでも満員/期限超過なら締切扱いになります。</div>
      </div>
    </div>

    <div class="btns">
      <button class="btn ghost" type="button" id="btnReload">再読み込み</button>
      <button class="btn ghost" type="button" id="btnBack2">部屋一覧へ戻る</button>
      <button class="btn primary" type="button" id="btnSave">保存</button>
    </div>

    <div id="saveMsg" class="notice hidden" style="margin-top:12px"></div>
  </div>

</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";
import { getFirestore, doc, getDoc, updateDoc, Timestamp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyAm1EIxmK_UWmRM7VMP7LREbMQhSYmylko",
  authDomain: "potoro-mahjong.firebaseapp.com",
  projectId: "potoro-mahjong",
  storageBucket: "potoro-mahjong.firebasestorage.app",
  messagingSenderId: "467297785940",
  appId: "1:467297785940:web:b1a0ed4cfa5ecd29a575c1",
  measurementId: "G-KTFZDLG5TL"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

const $ = (id)=>document.getElementById(id);

let currentUid = null;
onAuthStateChanged(auth, (u)=>{ if(u) currentUid = u.uid; });
signInAnonymously(auth).catch(()=>alert("Firebase認証に失敗しました（Anonymous Authを有効化してください）"));

/* ===== util ===== */
function is4DigitNumber(s){ return /^\d{4}$/.test(String(s||"").trim()); }
async function sha256Hex(text){
  const enc = new TextEncoder().encode(text);
  const buf = await crypto.subtle.digest("SHA-256", enc);
  return [...new Uint8Array(buf)].map(b => b.toString(16).padStart(2,"0")).join("");
}
function pad(n){ return String(n).padStart(2,"0"); }
function tsToLabel(ts){
  const d = ts.toDate();
  const w = ["日","月","火","水","木","金","土"][d.getDay()];
  return `${d.getFullYear()}/${pad(d.getMonth()+1)}/${pad(d.getDate())}(${w}) ${pad(d.getHours())}:${pad(d.getMinutes())}`;
}
function toLocalInputValue(date){
  // datetime-local はローカルタイム想定。JST環境前提。
  const y = date.getFullYear();
  const m = pad(date.getMonth()+1);
  const d = pad(date.getDate());
  const hh = pad(date.getHours());
  const mm = pad(date.getMinutes());
  return `${y}-${m}-${d}T${hh}:${mm}`;
}
function showMsg(el, text, isWarn=false){
  el.textContent = text;
  el.classList.remove("hidden");
  el.classList.toggle("warn", !!isWarn);
}
function hideMsg(el){
  el.classList.add("hidden");
  el.textContent = "";
  el.classList.remove("warn");
}

/* ===== read room ===== */
const params = new URLSearchParams(location.search);
const roomId = (params.get("id") || "").trim();

$("roomIdView").textContent = roomId || "（未指定）";
$("roomIdView2").textContent = roomId || "（未指定）";

if(!roomId){
  showMsg($("gateMsg"), "URLに ?id=部屋ID が必要です。例：mahjong-room-edit.html?id=RM-....", true);
}

function backToList(){
  location.href = "mahjong-room-list.html";
}
$("btnBack").addEventListener("click", backToList);
$("btnBack2").addEventListener("click", backToList);

const roomRef = roomId ? doc(db, "rooms", roomId) : null;

let roomCache = null;

async function loadRoom(){
  if(!roomRef) return null;
  const snap = await getDoc(roomRef);
  if(!snap.exists()) return null;
  roomCache = snap.data() || {};
  return roomCache;
}

function fillForm(r){
  $("creatorName").value = r.creatorName || "";
  $("rule").value = r.rule || "";
  $("eventAt").value = r.eventAt ? tsToLabel(r.eventAt) : "";
  $("endAt").value = r.endAt ? tsToLabel(r.endAt) : "";

  $("comment").value = (r.comment || "").toString();
  $("slotsTotal").value = Number.isFinite(Number(r.slotsTotal)) ? Number(r.slotsTotal) : "";
  $("closed").checked = !!r.closed;

  const dl = r.deadlineAt?.toDate?.() ? r.deadlineAt.toDate() : null;
  if(dl) $("deadlineLocal").value = toLocalInputValue(dl);
  else $("deadlineLocal").value = "";
}

function unlockEditor(){
  $("gate").classList.add("hidden");
  $("editor").classList.remove("hidden");
}

/* ===== gate logic ===== */
function hasEditSession(){
  try{
    const raw = sessionStorage.getItem(`potoro_edit_ok:${roomId}`);
    if(!raw) return false;
    const obj = JSON.parse(raw);
    // 有効期限：2時間（任意。短め推奨）
    if(!obj || !obj.ok) return false;
    if(Date.now() - (obj.at||0) > 2*60*60*1000) return false;
    return true;
  }catch(_){
    return false;
  }
}

async function ensureAuthed(){
  if(!roomId || !roomRef) return;

  const r = await loadRoom();
  if(!r){
    showMsg($("gateMsg"), "部屋が見つかりません。部屋IDをご確認ください。", true);
    return;
  }

  if(!r.deleteKeyHash){
    showMsg($("gateMsg"), "この部屋は削除キー未対応（deleteKeyHash未登録）のため編集できません。", true);
    return;
  }

  if(hasEditSession()){
    fillForm(r);
    unlockEditor();
  }else{
    // gate表示のまま
    $("gateKey").focus();
  }
}

$("btnVerify").addEventListener("click", async ()=>{
  hideMsg($("gateMsg"));
  if(!roomId || !roomRef){
    showMsg($("gateMsg"), "部屋IDが不正です。", true);
    return;
  }
  const key = $("gateKey").value.trim();
  if(!is4DigitNumber(key)){
    showMsg($("gateMsg"), "削除キーは4桁の数字で入力してください。", true);
    return;
  }

  const r = await loadRoom();
  if(!r){
    showMsg($("gateMsg"), "部屋が見つかりません。", true);
    return;
  }
  if(!r.deleteKeyHash){
    showMsg($("gateMsg"), "この部屋は削除キー未対応（deleteKeyHash未登録）のため編集できません。", true);
    return;
  }

  const hash = await sha256Hex(key);
  if(hash !== r.deleteKeyHash){
    showMsg($("gateMsg"), "削除キーが違います。", true);
    return;
  }

  // OK：セッション保存（キーは保存しない）
  const token = await sha256Hex(`${roomId}:${hash}:${Date.now()}`);
  sessionStorage.setItem(`potoro_edit_ok:${roomId}`, JSON.stringify({ ok:true, at:Date.now(), token }));

  fillForm(r);
  unlockEditor();
});

$("gateKey").addEventListener("keydown", (e)=>{
  if(e.key === "Enter"){
    e.preventDefault();
    $("btnVerify").click();
  }
});

/* ===== save ===== */
$("btnReload").addEventListener("click", async ()=>{
  hideMsg($("saveMsg"));
  const r = await loadRoom();
  if(!r){ showMsg($("saveMsg"), "再読み込みに失敗しました。", true); return; }
  fillForm(r);
  showMsg($("saveMsg"), "再読み込みしました。");
});

$("btnSave").addEventListener("click", async ()=>{
  hideMsg($("saveMsg"));
  if(!hasEditSession()){
    showMsg($("saveMsg"), "編集権限が確認できません。削除キーを再入力してください。", true);
    $("editor").classList.add("hidden");
    $("gate").classList.remove("hidden");
    return;
  }

  const r = await loadRoom();
  if(!r){
    showMsg($("saveMsg"), "部屋が見つかりません。", true);
    return;
  }

  // バリデーション
  const comment = ($("comment").value || "").toString().trim().slice(0,120);

  const slotsTotal = Number($("slotsTotal").value);
  if(!Number.isFinite(slotsTotal) || slotsTotal < 1 || slotsTotal > 20){
    showMsg($("saveMsg"), "募集人数は 1〜20 の範囲で入力してください。", true);
    return;
  }
  const joined = Number(r.joinedCount || 0);
  if(slotsTotal < joined){
    showMsg($("saveMsg"), `募集人数は現在の参加数（${joined}）未満にできません。`, true);
    return;
  }

  const dlStr = $("deadlineLocal").value;
  if(!dlStr){
    showMsg($("saveMsg"), "締切日時（deadlineAt）を入力してください。", true);
    return;
  }
  const dlDate = new Date(dlStr);
  if(Number.isNaN(dlDate.getTime())){
    showMsg($("saveMsg"), "締切日時の形式が不正です。", true);
    return;
  }

  const closed = !!$("closed").checked;

  // 反映：deadline超過や満員なら closed true に寄せてもいいが、ここでは入力値を優先
  const patch = {
    comment,
    slotsTotal,
    deadlineAt: Timestamp.fromDate(dlDate),
    closed
  };

  try{
    await updateDoc(roomRef, patch);
    const newR = await loadRoom();
    fillForm(newR);
    showMsg($("saveMsg"), "保存しました。");
  }catch(e){
    console.error(e);
    showMsg($("saveMsg"), "保存に失敗しました。Firestoreルール/権限を確認してください。", true);
  }
});

/* init */
ensureAuthed();
</script>
</body>
</html>
