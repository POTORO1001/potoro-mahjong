<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>POãƒ»TOROï½œéº»é›€ é¢å­å‹Ÿé›†ï½œéƒ¨å±‹ã‚’ä½œæˆ</title>
  <meta name="theme-color" content="#f6b7d2" />
  <meta name="description" content="POãƒ»TORO éº»é›€ã‚·ã‚¹ãƒ†ãƒ ã®é¢å­å‹Ÿé›†ï¼šéƒ¨å±‹ã‚’ä½œæˆã—ã¾ã™ã€‚" />
  <style>
    :root{
      --bg:#fff7fb;--card:#fff;--ink:#2b2b2b;--sub:#666;
      --accent:#ff79a6;--accent2:#7fc9ff;--ring:#ffd7e6;
      --shadow:0 12px 28px rgba(0,0,0,.08);
      --radius:18px;--ease:cubic-bezier(.2,.8,.2,1);
    }
    *{box-sizing:border-box}
    html,body{margin:0;height:100%;font-family:"Hiragino Kaku Gothic ProN","Noto Sans JP",system-ui;background:linear-gradient(135deg,#f6b7d2,#a9d6f7);color:var(--ink)}
    body::before{
      content:"";position:fixed;inset:-20%;pointer-events:none;z-index:-1;opacity:.75;
      background:
        radial-gradient(600px 420px at 15% 25%, rgba(255,255,255,.55), transparent 60%),
        radial-gradient(700px 520px at 85% 70%, rgba(255,255,255,.45), transparent 62%),
        radial-gradient(420px 320px at 55% 10%, rgba(255,250,252,.55), transparent 65%);
      filter: blur(2px);
    }
    a{color:#0b69d5;text-decoration:none}
    a:hover{text-decoration:underline}
    .wrap{width:min(980px,92vw);margin:0 auto;padding:18px 0 40px}
    header{
      position:sticky;top:0;z-index:50;background:rgba(255,255,255,.86);
      backdrop-filter:saturate(140%) blur(10px);box-shadow:0 2px 12px rgba(0,0,0,.08)
    }
    .nav{width:min(980px,92vw);margin:0 auto;display:flex;align-items:center;justify-content:space-between;padding:10px 0}
    .brand{display:flex;align-items:center;gap:10px}
    .logo{
      width:40px;height:40px;border-radius:50%;
      background:radial-gradient(circle at 30% 30%, #fff, #ffe2ee 60%, #ffd3ea 100%);
      display:grid;place-items:center;box-shadow:var(--shadow);font-weight:1000;color:#ff5ea8
    }
    .title{font-weight:1000;line-height:1.2}
    .title small{display:block;color:#666;font-weight:900}
    .btn{
      display:inline-flex;align-items:center;gap:8px;
      padding:10px 14px;border-radius:999px;border:1px solid rgba(0,0,0,.08);
      background:#fff;font-weight:1000;cursor:pointer;box-shadow:0 6px 14px rgba(0,0,0,.08);
      transition:transform .18s var(--ease), box-shadow .18s var(--ease);
    }
    .btn:hover{transform:translateY(-1px);box-shadow:0 12px 24px rgba(0,0,0,.12)}
    .btn.primary{
      border:none;color:#fff;background:linear-gradient(135deg,#ff81c0,#8ed2ff);
      box-shadow:0 16px 34px rgba(255,120,170,.30);
    }
    .btn.ghost{background:rgba(255,255,255,.95)}
    .card{
      background:rgba(255,255,255,.92);
      border:1px solid rgba(255,255,255,.7);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      padding:16px;
    }
    h1{margin:18px 0 10px;font-size:1.35rem;font-weight:1000}
    .lead{color:#444;font-weight:900;line-height:1.7;margin:0 0 14px}
    .grid{display:grid;gap:12px}
    @media (min-width:800px){ .grid.two{grid-template-columns:1fr 1fr} }
    label{display:block;font-weight:1000;margin:0 0 6px}
    .hint{color:var(--sub);font-weight:900;font-size:.86rem;line-height:1.6;margin-top:6px}
    input,select,textarea{
      width:100%;padding:12px 12px;border-radius:14px;border:1px solid rgba(0,0,0,.12);
      background:#fff;font-size:1rem;outline:none;
    }
    input:focus,select:focus,textarea:focus{border-color:rgba(255,121,166,.7);box-shadow:0 0 0 3px rgba(255,215,230,.75)}
    textarea{min-height:92px;resize:vertical}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .pill{
      display:inline-flex;align-items:center;gap:8px;padding:8px 10px;border-radius:999px;
      border:1px solid rgba(255,121,166,.20);
      background:linear-gradient(135deg, rgba(255,121,166,.14), rgba(127,201,255,.14));
      font-weight:1000;color:#333;
    }
    .radio{
      display:flex;gap:10px;flex-wrap:wrap
    }
    .radio label{
      display:inline-flex;align-items:center;gap:8px;
      padding:10px 12px;border-radius:999px;background:#fff;border:1px solid rgba(0,0,0,.08);
      box-shadow:0 6px 14px rgba(0,0,0,.08);cursor:pointer;margin:0;
    }
    .radio input{width:auto}
    .footer-actions{display:flex;gap:10px;flex-wrap:wrap;margin-top:12px}
    .status{
      margin-top:12px;padding:10px 12px;border-radius:14px;
      background:rgba(17,17,17,.88);color:#fff;font-weight:900;line-height:1.6;
      display:none;
    }
    .status.show{display:block}
    .mini{font-size:.86rem;color:#666;font-weight:900}
    code{background:#fff;border:1px solid #eee;border-radius:10px;padding:2px 8px}
  </style>
</head>

<body>
  <header>
    <div class="nav">
      <div class="brand">
        <div class="logo">PT</div>
        <div class="title">
          POãƒ»TORO éº»é›€ï½œå‹Ÿé›†éƒ¨å±‹ä½œæˆ
          <small>Firestore ãƒ«ãƒ¼ãƒ«æº–æ‹ ï¼ˆeventAt/deadlineAt Timestamp / deleteKeyã¯Hashã®ã¿ï¼‰</small>
        </div>
      </div>
      <div class="row">
        <a class="btn ghost" href="https://potoro1001.github.io/potoro-mahjong/" target="_blank" rel="noopener noreferrer">ğŸ€„ éº»é›€TOP</a>
        <a class="btn ghost" href="https://potoro1001.github.io/potoro-mahjong/rooms.html" target="_blank" rel="noopener noreferrer">ğŸ‘€ å‹Ÿé›†ã‚’è¦‹ã‚‹</a>
      </div>
    </div>
  </header>

  <main class="wrap">
    <h1>éƒ¨å±‹ã‚’ä½œæˆ</h1>
    <p class="lead">å…¥åŠ› â†’ ã€Œä½œæˆã™ã‚‹ã€ã§ Firestore <code>rooms</code> ã«ä¿å­˜ã—ã¾ã™ã€‚<br>â€»å‰Šé™¤ã‚­ãƒ¼ã¯<strong>ç”Ÿãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜ã›ãš</strong>ã€SHA-256ã§ãƒãƒƒã‚·ãƒ¥åŒ–ã—ãŸ <code>deleteKeyHash</code> ã®ã¿ä¿å­˜ã—ã¾ã™ã€‚</p>

    <section class="card grid">
      <div class="grid two">
        <div>
          <label for="creatorName">ä½œæˆè€…åï¼ˆ30æ–‡å­—ã¾ã§ï¼‰</label>
          <input id="creatorName" type="text" maxlength="30" placeholder="ä¾‹ï¼šãƒˆãƒ­ ãƒ" autocomplete="name" />
          <div class="hint">Firestoreãƒ«ãƒ¼ãƒ«ï¼š<code>creatorName</code> ã¯å¿…é ˆï¼ˆ1ã€œ30æ–‡å­—ï¼‰</div>
        </div>

        <div>
          <label>å¯¾å±€ãƒ«ãƒ¼ãƒ«</label>
          <div class="radio" role="radiogroup" aria-label="å¯¾å±€ãƒ«ãƒ¼ãƒ«">
            <label><input type="radio" name="rule" value="å››äººæ‰“ã¡" checked /> å››äººæ‰“ã¡</label>
            <label><input type="radio" name="rule" value="ä¸‰äººæ‰“ã¡" /> ä¸‰äººæ‰“ã¡</label>
          </div>
          <div class="hint">Firestoreãƒ«ãƒ¼ãƒ«ï¼š<code>rule</code> ã¯ã€Œä¸‰äººæ‰“ã¡ / å››äººæ‰“ã¡ã€ã®ã¿</div>
        </div>
      </div>

      <div class="grid two">
        <div>
          <label for="eventAt">é–‹å§‹æ—¥æ™‚ï¼ˆå¿…é ˆï¼‰</label>
          <input id="eventAt" type="datetime-local" />
          <div class="hint">Firestoreãƒ«ãƒ¼ãƒ«ï¼š<code>eventAt</code> ã¯ Timestamp å¿…é ˆ</div>
        </div>

        <div>
          <label for="durationMinutes">äºˆå®šæ™‚é–“ï¼ˆåˆ†ï¼‰</label>
          <select id="durationMinutes">
            <option value="60">60åˆ†</option>
            <option value="90">90åˆ†</option>
            <option value="120" selected>120åˆ†</option>
            <option value="150">150åˆ†</option>
            <option value="180">180åˆ†</option>
          </select>
          <div class="hint">ä»»æ„ï¼šä¿å­˜ã™ã‚‹ãªã‚‰ <code>durationMinutes</code> ã¯ int</div>
        </div>
      </div>

      <div class="grid two">
        <div>
          <label for="deadlineAt">ç· åˆ‡æ—¥æ™‚ï¼ˆå¿…é ˆï¼‰</label>
          <input id="deadlineAt" type="datetime-local" />
          <div class="hint">Firestoreãƒ«ãƒ¼ãƒ«ï¼š<code>deadlineAt</code> ã¯ Timestamp å¿…é ˆ</div>
        </div>

        <div>
          <label for="slotsTotal">å‹Ÿé›†äººæ•°ï¼ˆå‚åŠ è€…æ ï¼‰</label>
          <select id="slotsTotal">
            <option value="1">1äºº</option>
            <option value="2">2äºº</option>
            <option value="3" selected>3äºº</option>
          </select>
          <div class="hint">
            Firestoreãƒ«ãƒ¼ãƒ«ï¼šå››äººæ‰“ã¡ã¯æœ€å¤§3 / ä¸‰äººæ‰“ã¡ã¯æœ€å¤§2ï¼ˆ<code>slotsTotal</code> ã¯ intï¼‰
          </div>
        </div>
      </div>

      <div>
        <label for="comment">ã‚³ãƒ¡ãƒ³ãƒˆï¼ˆä»»æ„ãƒ»140æ–‡å­—ã¾ã§ï¼‰</label>
        <textarea id="comment" maxlength="140" placeholder="ä¾‹ï¼šåˆå¿ƒè€…æ­“è¿ï¼19æ™‚é–‹å§‹ï¼é€”ä¸­å‚åŠ OK ãªã©"></textarea>
        <div class="hint">Firestoreãƒ«ãƒ¼ãƒ«ï¼šå…¥ã‚Œã‚‹å ´åˆ <code>comment</code> ã¯æ–‡å­—åˆ— &amp; 140æ–‡å­—ä»¥å†…</div>
      </div>

      <div class="grid two">
        <div>
          <label for="deleteKey">4æ¡å‰Šé™¤ã‚­ãƒ¼ï¼ˆä»»æ„ï¼‰</label>
          <input id="deleteKey" inputmode="numeric" pattern="\\d{4}" maxlength="4" placeholder="ä¾‹ï¼š1234" />
          <div class="hint">
            âš ï¸ <strong>ç”Ÿã®deleteKeyã¯Firestoreã«ä¿å­˜ã—ã¾ã›ã‚“</strong>ï¼ˆä¿å­˜ã™ã‚‹ã¨ãƒ«ãƒ¼ãƒ«é•åã«ãªã‚ŠãŒã¡ï¼‰<br>
            ä¿å­˜ã™ã‚‹ã®ã¯ <code>deleteKeyHash</code>ï¼ˆSHA-256 / 64æ–‡å­—ï¼‰ã®ã¿ã§ã™
          </div>
        </div>

        <div>
          <label>ãƒ­ã‚°ã‚¤ãƒ³çŠ¶æ…‹</label>
          <div class="row">
            <span class="pill">ğŸ” uidï¼š<span id="uidText">èªè¨¼ä¸­â€¦</span></span>
          </div>
          <div class="hint">Firestoreãƒ«ãƒ¼ãƒ«ï¼šread/create/update ã¯ <code>request.auth != null</code> ãŒå¿…è¦ï¼ˆåŒ¿åãƒ­ã‚°ã‚¤ãƒ³å¯¾å¿œï¼‰</div>
        </div>
      </div>

      <div class="footer-actions">
        <button class="btn primary" id="btnCreate" type="button">âœ¨ ä½œæˆã™ã‚‹</button>
        <button class="btn ghost" id="btnFillSample" type="button">ğŸ§ª ãƒ†ã‚¹ãƒˆå…¥åŠ›</button>
        <button class="btn ghost" id="btnClear" type="button">ğŸ§¹ ã‚¯ãƒªã‚¢</button>
      </div>

      <div id="status" class="status" role="status" aria-live="polite"></div>
      <div class="mini">â€»ã“ã®ãƒšãƒ¼ã‚¸ã¯ã€Œãƒ«ãƒ¼ãƒ«ã«é€šã‚‹payloadã€ã‚’æœ€å„ªå…ˆã§ä½œã£ã¦ã‚ã‚Šã¾ã™ã€‚</div>
    </section>
  </main>

  <!-- Firebaseï¼ˆv10ç³»ï¼‰ -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getAuth, onAuthStateChanged, signInAnonymously } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
    import { getFirestore, collection, addDoc, Timestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    // ====== ã“ã“ã‚’ã‚ãªãŸã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã«åˆã‚ã›ã¦ãã ã•ã„ ======
    // æ—¢ã«ãƒãƒ¼ã‚¿ãƒ«ç­‰ã§ä½¿ã£ã¦ã„ã‚‹ã®ã¨åŒã˜ã§OK
    const FIREBASE_CONFIG = window.MAHJONG_FIREBASE_CONFIG || {
      apiKey: "YOUR_API_KEY",
      authDomain: "YOUR_PROJECT.firebaseapp.com",
      projectId: "YOUR_PROJECT_ID"
    };
    // ==============================================

    const $ = (id)=>document.getElementById(id);
    const statusEl = $("status");
    const uidText = $("uidText");

    const setStatus = (msg, isError=false)=>{
      statusEl.textContent = msg;
      statusEl.classList.add("show");
      statusEl.style.background = isError ? "rgba(150,0,40,.92)" : "rgba(17,17,17,.88)";
    };

    const clearStatus = ()=> statusEl.classList.remove("show");

    const toDateFromLocalInput = (v)=>{
      // datetime-local ã¯ãƒ­ãƒ¼ã‚«ãƒ«æ™‚åˆ»æ–‡å­—åˆ—ãªã®ã§ new Date(v) ã§ãƒ­ãƒ¼ã‚«ãƒ«è§£é‡ˆã•ã‚Œã‚‹
      const d = new Date(v);
      return (d instanceof Date && !isNaN(d)) ? d : null;
    };

    const sha256Hex = async (text)=>{
      const enc = new TextEncoder().encode(text);
      const buf = await crypto.subtle.digest("SHA-256", enc);
      const arr = Array.from(new Uint8Array(buf));
      return arr.map(b=>b.toString(16).padStart(2,"0")).join("");
    };

    const ensureInt = (n)=> Number.isInteger(n) ? n : null;

    // åˆæœŸåŒ–
    if(!FIREBASE_CONFIG.projectId || FIREBASE_CONFIG.projectId === "YOUR_PROJECT_ID"){
      setStatus("Firebaseè¨­å®šï¼ˆapiKey/authDomain/projectIdï¼‰ãŒæœªè¨­å®šã§ã™ã€‚ä¸Šã® FIREBASE_CONFIG ã‚’å·®ã—æ›¿ãˆã¦ãã ã•ã„ã€‚", true);
      uidText.textContent = "æœªè¨­å®š";
      throw new Error("Firebase config missing");
    }

    const app = initializeApp(FIREBASE_CONFIG);
    const auth = getAuth(app);
    const db = getFirestore(app);

    // èªè¨¼ï¼ˆåŒ¿åï¼‰
    let currentUid = null;
    onAuthStateChanged(auth, async (user)=>{
      if(user){
        currentUid = user.uid;
        uidText.textContent = user.uid.slice(0,8) + "â€¦";
        clearStatus();
      }else{
        uidText.textContent = "èªè¨¼ä¸­â€¦";
        try{
          await signInAnonymously(auth);
        }catch(e){
          currentUid = null;
          uidText.textContent = "å¤±æ•—";
          setStatus("åŒ¿åãƒ­ã‚°ã‚¤ãƒ³ã«å¤±æ•—ã—ã¾ã—ãŸã€‚Firebase Authï¼ˆåŒ¿åï¼‰ã‚’æœ‰åŠ¹åŒ–ã—ã¦ãã ã•ã„ã€‚", true);
        }
      }
    });

    // ãƒ†ã‚¹ãƒˆå…¥åŠ›
    $("btnFillSample").addEventListener("click", ()=>{
      $("creatorName").value = "ãƒˆãƒ­ ãƒ";
      const now = new Date();
      const pad2 = (x)=>String(x).padStart(2,"0");
      const toLocal = (d)=>{
        const y=d.getFullYear();
        const m=pad2(d.getMonth()+1);
        const da=pad2(d.getDate());
        const h=pad2(d.getHours());
        const mi=pad2(d.getMinutes());
        return `${y}-${m}-${da}T${h}:${mi}`;
      };
      const start = new Date(now.getTime() + 60*60*1000);
      const deadline = new Date(now.getTime() + 30*60*1000);
      $("eventAt").value = toLocal(start);
      $("deadlineAt").value = toLocal(deadline);
      $("durationMinutes").value = "120";
      $("slotsTotal").value = "3";
      document.querySelector('input[name="rule"][value="å››äººæ‰“ã¡"]').checked = true;
      $("comment").value = "ãƒ†ã‚¹ãƒˆå‹Ÿé›†ï¼šåˆå¿ƒè€…æ­“è¿ã§ã™â™¡";
      $("deleteKey").value = "1234";
      setStatus("ãƒ†ã‚¹ãƒˆå…¥åŠ›ã‚’å…¥ã‚Œã¾ã—ãŸã€‚ä½œæˆã‚’æŠ¼ã™ã¨ä¿å­˜ã—ã¾ã™ã€‚");
    });

    // ã‚¯ãƒªã‚¢
    $("btnClear").addEventListener("click", ()=>{
      ["creatorName","eventAt","deadlineAt","comment","deleteKey"].forEach(id=>$(id).value="");
      $("durationMinutes").value = "120";
      $("slotsTotal").value = "3";
      document.querySelector('input[name="rule"][value="å››äººæ‰“ã¡"]').checked = true;
      clearStatus();
    });

    // ä½œæˆ
    $("btnCreate").addEventListener("click", async ()=>{
      if(!currentUid){
        setStatus("èªè¨¼ä¸­ã§ã™ã€‚æ•°ç§’å¾…ã£ã¦ã‹ã‚‰ã‚‚ã†ä¸€åº¦ãŠè©¦ã—ãã ã•ã„ã€‚", true);
        return;
      }

      const creatorName = $("creatorName").value.trim();
      const rule = (document.querySelector('input[name="rule"]:checked')?.value || "").trim();
      const eventAtLocal = $("eventAt").value;
      const deadlineAtLocal = $("deadlineAt").value;

      const durationMinutesNum = Number($("durationMinutes").value);
      const slotsTotalNum = Number($("slotsTotal").value);

      const commentRaw = ($("comment").value || "").trim();
      const deleteKey = ($("deleteKey").value || "").trim();

      // ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ï¼ˆãƒ«ãƒ¼ãƒ«æº–æ‹ ï¼‰
      if(!creatorName || creatorName.length > 30){
        setStatus("ä½œæˆè€…åã‚’1ã€œ30æ–‡å­—ã§å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚", true); return;
      }
      if(rule !== "ä¸‰äººæ‰“ã¡" && rule !== "å››äººæ‰“ã¡"){
        setStatus("ãƒ«ãƒ¼ãƒ«ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚", true); return;
      }
      const eventDate = toDateFromLocalInput(eventAtLocal);
      const deadlineDate = toDateFromLocalInput(deadlineAtLocal);
      if(!eventDate){ setStatus("é–‹å§‹æ—¥æ™‚ï¼ˆeventAtï¼‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚", true); return; }
      if(!deadlineDate){ setStatus("ç· åˆ‡æ—¥æ™‚ï¼ˆdeadlineAtï¼‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚", true); return; }

      const durationMinutes = ensureInt(durationMinutesNum);
      const slotsTotal = ensureInt(slotsTotalNum);
      if(durationMinutes === null || durationMinutes <= 0){
        setStatus("äºˆå®šæ™‚é–“ï¼ˆdurationMinutesï¼‰ãŒä¸æ­£ã§ã™ã€‚", true); return;
      }
      if(slotsTotal === null || slotsTotal < 1){
        setStatus("å‹Ÿé›†äººæ•°ï¼ˆslotsTotalï¼‰ãŒä¸æ­£ã§ã™ã€‚", true); return;
      }

      if(rule === "å››äººæ‰“ã¡" && slotsTotal > 3){
        setStatus("å››äººæ‰“ã¡ã¯å‹Ÿé›†äººæ•°ï¼ˆå‚åŠ è€…æ ï¼‰ã¯æœ€å¤§3ã§ã™ã€‚", true); return;
      }
      if(rule === "ä¸‰äººæ‰“ã¡" && slotsTotal > 2){
        setStatus("ä¸‰äººæ‰“ã¡ã¯å‹Ÿé›†äººæ•°ï¼ˆå‚åŠ è€…æ ï¼‰ã¯æœ€å¤§2ã§ã™ã€‚", true); return;
      }

      if(commentRaw.length > 140){
        setStatus("ã‚³ãƒ¡ãƒ³ãƒˆã¯140æ–‡å­—ä»¥å†…ã«ã—ã¦ãã ã•ã„ã€‚", true); return;
      }

      // deleteKey ã¯ä¿å­˜ã—ãªã„ã€‚ä¿å­˜ã™ã‚‹ã®ã¯ hash ã®ã¿ï¼ˆä»»æ„ï¼‰
      let deleteKeyHash = null;
      if(deleteKey){
        if(!/^\d{4}$/.test(deleteKey)){
          setStatus("å‰Šé™¤ã‚­ãƒ¼ã¯4æ¡ã®æ•°å­—ã§å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚", true); return;
        }
        deleteKeyHash = await sha256Hex(deleteKey); // 64æ–‡å­—
      }

      // endAt ã¯ä»»æ„ï¼ˆã‚ãªãŸã®ãƒ«ãƒ¼ãƒ«ã§è¨±å¯ã•ã‚Œã¦ã‚‹ï¼‰
      const endDate = new Date(eventDate.getTime() + durationMinutes * 60 * 1000);

      // ====== ãƒ«ãƒ¼ãƒ«ã«é€šã‚‹ payloadï¼ˆã“ã“ãŒè¶…é‡è¦ï¼‰======
      const payload = {
        creatorName,
        creatorUid: currentUid,                    // ãƒ«ãƒ¼ãƒ«å¿…é ˆ
        eventAt: Timestamp.fromDate(eventDate),    // timestampå¿…é ˆ
        deadlineAt: Timestamp.fromDate(deadlineDate), // timestampå¿…é ˆ
        slotsTotal,                                // intå¿…é ˆ
        joinedCount: 0,                            // intå¿…é ˆï¼ˆ0å›ºå®šï¼‰
        rule,                                      // å¿…é ˆ
        closed: false                              // boolå¿…é ˆ
      };

      // ä»»æ„é …ç›®ï¼ˆå…¥ã‚Œã‚‹ãªã‚‰å‹ã‚’å®ˆã‚‹ï¼‰
      if(commentRaw) payload.comment = commentRaw;
      payload.durationMinutes = durationMinutes;                 // ä»»æ„ã ãŒå…¥ã‚Œã¦OKï¼ˆintï¼‰
      payload.endAt = Timestamp.fromDate(endDate);               // ä»»æ„ï¼ˆtimestampï¼‰
      if(deleteKeyHash) payload.deleteKeyHash = deleteKeyHash;   // ä»»æ„ï¼ˆ64æ–‡å­—ï¼‰

      // âš ï¸ ç”Ÿã® deleteKey ã¯çµ¶å¯¾ã« payload ã«å…¥ã‚Œãªã„ï¼ˆãƒ«ãƒ¼ãƒ«é•åã«ãªã‚Šã‚„ã™ã„ï¼‰
      // ===============================================

      try{
        setStatus("ä¿å­˜ä¸­â€¦");
        const ref = await addDoc(collection(db, "rooms"), payload);
        setStatus(`ä¿å­˜ã—ã¾ã—ãŸï¼ roomIdï¼š${ref.id}`);

        // ã“ã“ã§é·ç§»ã—ãŸã‘ã‚Œã°æœ‰åŠ¹åŒ–
        // location.href = "rooms.html";
      }catch(e){
        // Firestoreæ¨©é™ã‚¨ãƒ©ãƒ¼ã¯ã ã„ãŸã„ã“ã‚Œ
        const msg = String(e?.message || e || "");
        const isPerm = /permission|PERMISSION_DENIED|Missing or insufficient permissions/i.test(msg);
        setStatus(
          isPerm
            ? "ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸï¼šæ¨©é™ï¼ˆFirestore Rulesï¼‰ã«ã‚ˆã‚Šæ‹’å¦ã•ã‚Œã¾ã—ãŸã€‚payloadã®å‹/ã‚­ãƒ¼ãŒãƒ«ãƒ¼ãƒ«ã¨ä¸€è‡´ã—ã¦ã„ã‚‹ã‹ç¢ºèªã—ã¦ãã ã•ã„ã€‚"
            : ("ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸï¼š" + msg),
          true
        );
        console.error(e);
      }
    });
  </script>

  <noscript>JavaScriptãŒç„¡åŠ¹ã«ãªã£ã¦ã„ã¾ã™ã€‚éƒ¨å±‹ä½œæˆã«ã¯JavaScriptãŒå¿…è¦ã§ã™ã€‚</noscript>
</body>
</html>
