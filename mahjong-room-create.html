<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>PO・TORO｜面子募集の部屋を作成</title>
<meta name="theme-color" content="#f6b7d2" />
<style>
:root{--bg:#fff7fb;--card:#fff;--ink:#2b2b2b;--sub:#666;--accent:#ff79a6;--accent2:#7fc9ff;--ring:#ffd7e6;--radius:20px;--shadow:0 12px 28px rgba(0,0,0,.08)}
*{box-sizing:border-box}
body{margin:0;font-family:"Hiragino Kaku Gothic ProN","Noto Sans JP",system-ui;background:linear-gradient(180deg,var(--bg),#fff);color:var(--ink)}
.wrap{max-width:780px;margin:0 auto;padding:20px}
header{display:flex;justify-content:space-between;align-items:flex-end;gap:12px;margin-bottom:14px}
h1{margin:0;font-size:22px}
.sub{font-size:13px;color:var(--sub);margin-top:6px}
.card{background:rgba(255,255,255,.9);border:1px solid var(--ring);border-radius:var(--radius);padding:18px;box-shadow:var(--shadow)}
.field{margin-bottom:14px}
label{display:block;font-weight:900;font-size:14px;margin-bottom:6px}
input,select,textarea{width:100%;padding:10px 12px;border-radius:12px;border:1px solid #ddd;font-size:14px;background:#fff}
textarea{min-height:88px;resize:vertical}
.row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
@media (max-width:720px){.row{grid-template-columns:1fr}}
.radio{display:flex;gap:14px;flex-wrap:wrap}
.btn{width:100%;padding:14px;border:none;border-radius:14px;font-weight:1000;font-size:15px;cursor:pointer;background:linear-gradient(135deg,var(--accent),var(--accent2));color:#fff}
.ok{display:none;margin-top:14px;border-radius:18px;padding:12px 14px;background:#f6fff8;border:1px solid rgba(46,204,113,.35)}
.small{font-size:12px;color:var(--sub)}
</style>
</head>
<body>
<div class="wrap">
  <header>
    <div>
      <h1>面子募集の部屋を作成</h1>
      <div class="sub">Firestore保存 + 利用時間対応版</div>
    </div>
  </header>

  <div class="card">

    <div class="field">
      <label>作成者名</label>
      <input id="creatorName" maxlength="30" />
    </div>

    <div class="row">
      <div class="field">
        <label>開催日時（開始時刻）</label>
        <input id="eventAt" type="datetime-local" />
      </div>

      <div class="field">
        <label>利用時間</label>
        <select id="durationHours">
          <option value="">選択してください</option>
          <option value="1">1時間</option>
          <option value="2">2時間</option>
          <option value="3">3時間</option>
          <option value="4">4時間以上</option>
        </select>
      </div>
    </div>

    <div class="row">
      <div class="field">
        <label>募集締切（任意）</label>
        <input id="deadlineAt" type="datetime-local" />
      </div>

      <div class="field">
        <label>募集人数</label>
        <select id="slotsTotal">
          <option value="">選択してください</option>
          <option value="1">1名</option>
          <option value="2">2名</option>
          <option value="3">3名</option>
        </select>
      </div>
    </div>

    <div class="field">
      <label>三打ち or 四打ち</label>
      <div class="radio">
        <label><input type="radio" name="rule" value="三打ち">三打ち</label>
        <label><input type="radio" name="rule" value="四打ち">四打ち</label>
      </div>
    </div>

    <button class="btn" onclick="createRoom()">部屋を作成</button>

    <div id="ok" class="ok"></div>
  </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";
import { getFirestore, doc, setDoc, serverTimestamp, Timestamp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "REPLACE_ME",
  authDomain: "REPLACE_ME",
  projectId: "REPLACE_ME",
  storageBucket: "REPLACE_ME",
  messagingSenderId: "REPLACE_ME",
  appId: "REPLACE_ME"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

let currentUid = null;
onAuthStateChanged(auth, u => { if(u) currentUid = u.uid; });
signInAnonymously(auth);

function pad(n){ return String(n).padStart(2,"0"); }
function generateRoomId(eventAtISO){
  const d = new Date(eventAtISO);
  const yy = String(d.getFullYear()).slice(-2);
  const mm = pad(d.getMonth()+1);
  const dd = pad(d.getDate());
  const hh = pad(d.getHours());
  const mi = pad(d.getMinutes());
  const rnd = Math.random().toString(16).slice(2,6).toUpperCase();
  return `RM-${yy}${mm}${dd}-${hh}${mi}-${rnd}`;
}

window.createRoom = async function(){
  const creatorName = document.getElementById("creatorName").value.trim();
  const eventAtLocal = document.getElementById("eventAt").value;
  const durationHours = Number(document.getElementById("durationHours").value);
  const deadlineAtLocal = document.getElementById("deadlineAt").value;
  const slotsTotal = Number(document.getElementById("slotsTotal").value);
  const ruleEl = document.querySelector('input[name="rule"]:checked');

  if(!creatorName || !eventAtLocal || !durationHours || !slotsTotal || !ruleEl){
    alert("未入力の項目があります。");
    return;
  }

  const eventDate = new Date(eventAtLocal);
  const endDate = new Date(eventDate);
  endDate.setHours(endDate.getHours() + durationHours);

  const deadlineDate = deadlineAtLocal
    ? new Date(deadlineAtLocal)
    : new Date(eventDate.getTime() - 30*60000);

  const roomId = generateRoomId(eventAtLocal);

  await setDoc(doc(db,"rooms",roomId),{
    id: roomId,
    creatorUid: currentUid,
    creatorName,
    eventAt: Timestamp.fromDate(eventDate),
    endAt: Timestamp.fromDate(endDate),
    durationHours,
    deadlineAt: Timestamp.fromDate(deadlineDate),
    slotsTotal,
    joinedCount: 0,
    rule: ruleEl.value,
    closed: false,
    createdAt: serverTimestamp()
  });

  document.getElementById("ok").style.display="block";
  document.getElementById("ok").innerHTML =
    `保存しました。<br>終了予定：${endDate.toLocaleString()}`;
};
</script>
</body>
</html>
