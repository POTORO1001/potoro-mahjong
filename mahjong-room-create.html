<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>PO・TORO｜面子募集の部屋を作成</title>
<meta name="description" content="麻雀 面子募集 部屋作成ページ" />
<meta name="theme-color" content="#f6b7d2" />
<style>
:root{
  --bg:#fff7fb; --card:#fff; --ink:#2b2b2b; --sub:#666;
  --accent:#ff79a6; --accent2:#7fc9ff; --ring:#ffd7e6;
  --radius:20px; --shadow:0 12px 28px rgba(0,0,0,.08);
  --danger:#ff5b6a; --ok:#2ecc71;
}
*{box-sizing:border-box}
body{
  margin:0; font-family:"Hiragino Kaku Gothic ProN","Noto Sans JP",system-ui;
  background:
    radial-gradient(1200px 600px at 15% 10%, rgba(255,121,166,.18), transparent 55%),
    radial-gradient(900px 500px at 85% 20%, rgba(127,201,255,.20), transparent 60%),
    linear-gradient(180deg,var(--bg),#fff 60%);
  color:var(--ink);
}
.wrap{max-width:780px;margin:0 auto;padding:20px}
header{display:flex;justify-content:space-between;align-items:flex-end;gap:12px;margin-bottom:14px}
h1{margin:0;font-size:22px}
.sub{font-size:13px;color:var(--sub);margin-top:6px}
.badge{
  font-size:12px;padding:7px 10px;border-radius:999px;background:rgba(255,255,255,.7);
  border:1px solid rgba(255,121,166,.22); color:#b34a6a; white-space:nowrap;
}
.card{
  background:rgba(255,255,255,.82); border:1px solid var(--ring); border-radius:var(--radius);
  padding:18px; box-shadow:var(--shadow);
}
.field{margin-bottom:14px}
label{display:block;font-weight:800;font-size:14px;margin-bottom:6px}
input,select,textarea{
  width:100%; padding:10px 12px; border-radius:12px; border:1px solid #ddd;
  font-size:14px; font-family:inherit; background:#fff;
}
textarea{resize:vertical; min-height:88px}
.row{display:grid; grid-template-columns:1fr 1fr; gap:12px}
@media (max-width:720px){.row{grid-template-columns:1fr}}
.radio-group{display:flex; gap:14px; flex-wrap:wrap}
.radio-group label{font-weight:600; display:flex; align-items:center; gap:6px; margin:0}
.hint{font-size:12px;color:var(--sub);margin-top:6px;line-height:1.5}
.btn{
  width:100%; padding:14px; border:none; border-radius:14px; font-weight:900; font-size:15px;
  cursor:pointer; background:linear-gradient(135deg,var(--accent),var(--accent2)); color:#fff;
  box-shadow:0 10px 18px rgba(0,0,0,.12);
}
.btn:hover{filter:brightness(.98)}
.note{
  margin-top:12px; font-size:12px; color:#7a6a70; line-height:1.6;
  background:rgba(255,255,255,.7); border:1px solid rgba(0,0,0,.06); border-radius:14px; padding:10px 12px;
}
.okbox{
  display:none; margin-top:16px; padding:14px 14px; border-radius:18px;
  background:#f6fff8; border:1px solid rgba(46,204,113,.35);
}
.okbox b{display:block;margin-bottom:6px}
.links{display:flex;gap:10px;flex-wrap:wrap;margin-top:10px}
.linkbtn{
  display:inline-block; padding:10px 12px; border-radius:14px; font-weight:800; font-size:13px;
  background:#fff; border:1px solid rgba(255,121,166,.22); text-decoration:none;
}
.back{margin-top:16px;text-align:center}
.back a{font-size:13px;color:#888;text-decoration:none}
.small{font-size:12px;color:var(--sub)}
</style>
</head>
<body>
<div class="wrap">
  <header>
    <div>
      <h1>面子募集の部屋を作成</h1>
      <div class="sub">入力 → 作成 → 一覧ページに表示されます（localStorage保存）</div>
    </div>
    <div class="badge">PO・TORO / Mahjong</div>
  </header>

  <div class="card">
    <div class="field">
      <label>作成者名</label>
      <input type="text" id="creator" placeholder="例：トロご主人様" maxlength="30" />
    </div>

    <div class="row">
      <div class="field">
        <label>開催日時</label>
        <input type="datetime-local" id="eventAt" />
        <div class="hint">※開始時刻の目安（例：19:00）</div>
      </div>
      <div class="field">
        <label>募集締切（任意）</label>
        <input type="datetime-local" id="deadlineAt" />
        <div class="hint">※未入力の場合は「開催日時の30分前」を自動設定します</div>
      </div>
    </div>

    <div class="row">
      <div class="field">
        <label>募集人数</label>
        <select id="slots">
          <option value="">選択してください</option>
          <option value="1">1名</option>
          <option value="2">2名</option>
          <option value="3">3名</option>
        </select>
        <div class="hint">※残り人数は「募集人数 − 参加人数」で自動計算されます</div>
      </div>

      <div class="field">
        <label>三打ち or 四打ち</label>
        <div class="radio-group">
          <label><input type="radio" name="rule" value="三打ち">三打ち</label>
          <label><input type="radio" name="rule" value="四打ち">四打ち</label>
        </div>
      </div>
    </div>

    <div class="field">
      <label>ひとこと（任意）</label>
      <textarea id="comment" placeholder="例：初心者歓迎です！楽しく打てる方お待ちしています。" maxlength="140"></textarea>
      <div class="small"><span id="count">0</span>/140</div>
    </div>

    <button class="btn" type="button" onclick="createRoom()">部屋を作成して保存</button>

    <div class="note">
      <b>このページでやっていること</b>
      ・部屋IDを自動生成して、募集データを localStorage に保存します。<br>
      ・締切を過ぎた部屋は自動的に「締切済み」扱いになります。<br>
      ・残り人数は一覧ページで自動計算・自動更新されます（参加ボタンで増減）。
    </div>

    <div class="okbox" id="okbox">
      <b>保存しました！</b>
      <div id="oktext" class="small"></div>
      <div class="links">
        <a class="linkbtn" href="mahjong-room-list.html">一覧ページへ</a>
        <a class="linkbtn" href="mahjong-lobby.html">面子募集トップへ</a>
      </div>
    </div>
  </div>

  <div class="back">
    <a href="mahjong-lobby.html">← 面子募集トップへ戻る</a>
  </div>
</div>

<script>
const STORAGE_KEY = "potoro_mahjong_rooms_v1";

const $ = (id)=>document.getElementById(id);

function loadRooms(){
  try{ return JSON.parse(localStorage.getItem(STORAGE_KEY) || "[]"); }
  catch(e){ return []; }
}
function saveRooms(rooms){
  localStorage.setItem(STORAGE_KEY, JSON.stringify(rooms));
}

// ID： "RM-YYMMDD-HHMM-XXXX" 形式（XXXXは乱数）
function generateRoomId(eventAtISO){
  const d = new Date(eventAtISO);
  const pad = (n)=>String(n).padStart(2,"0");
  const yy = String(d.getFullYear()).slice(-2);
  const mm = pad(d.getMonth()+1);
  const dd = pad(d.getDate());
  const hh = pad(d.getHours());
  const mi = pad(d.getMinutes());
  const rnd = Math.random().toString(16).slice(2,6).toUpperCase();
  return `RM-${yy}${mm}${dd}-${hh}${mi}-${rnd}`;
}

function isoToLocalLabel(iso){
  const d = new Date(iso);
  const w = ["日","月","火","水","木","金","土"][d.getDay()];
  const pad = (n)=>String(n).padStart(2,"0");
  return `${d.getFullYear()}/${pad(d.getMonth()+1)}/${pad(d.getDate())}(${w}) ${pad(d.getHours())}:${pad(d.getMinutes())}`;
}

function createRoom(){
  const creator = $("creator").value.trim();
  const eventAt = $("eventAt").value;
  const deadlineAtInput = $("deadlineAt").value;
  const slotsStr = $("slots").value;
  const ruleEl = document.querySelector('input[name="rule"]:checked');
  const comment = $("comment").value.trim();

  if(!creator || !eventAt || !slotsStr || !ruleEl){
    alert("未入力の項目があります（作成者名 / 開催日時 / 募集人数 / 三打ちor四打ち）。");
    return;
  }

  const slots = Number(slotsStr);
  if(!Number.isFinite(slots) || slots < 1){
    alert("募集人数が不正です。");
    return;
  }

  // 締切：未入力なら開催の30分前
  let deadlineAt = deadlineAtInput;
  if(!deadlineAt){
    const d = new Date(eventAt);
    d.setMinutes(d.getMinutes() - 30);
    deadlineAt = d.toISOString().slice(0,16); // datetime-local相当
  }

  const eventISO = new Date(eventAt).toISOString();
  const deadlineISO = new Date(deadlineAt).toISOString();

  // 締切が開催より後なら、締切=開催に丸め（安全）
  if(new Date(deadlineISO) > new Date(eventISO)){
    deadlineAt = eventAt;
  }

  const room = {
    id: generateRoomId(eventAt),
    createdAt: new Date().toISOString(),
    creator,
    eventAt: new Date(eventAt).toISOString(),
    deadlineAt: new Date(deadlineAt).toISOString(),
    slotsTotal: slots,
    joinedCount: 0, // 一覧ページで参加操作により増える
    rule: ruleEl.value,
    comment,
    closed: false
  };

  // 既存に追加（新しい順）
  const rooms = loadRooms();
  rooms.unshift(room);
  saveRooms(rooms);

  $("oktext").textContent = `部屋ID：${room.id} / 開催：${isoToLocalLabel(room.eventAt)} / 締切：${isoToLocalLabel(room.deadlineAt)}`;
  $("okbox").style.display = "block";
  window.scrollTo({top: document.body.scrollHeight, behavior:"smooth"});
}

// 文字数カウント
$("comment").addEventListener("input", ()=>{
  $("count").textContent = String($("comment").value.length);
});
</script>
</body>
</html>

