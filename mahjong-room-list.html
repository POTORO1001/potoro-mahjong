<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>PO・TORO｜面子募集の部屋を見る</title>
<meta name="theme-color" content="#f6b7d2" />
<style>
:root{
  --bg:#fff7fb;--ink:#2b2b2b;--sub:#666;
  --accent:#ff79a6;--accent2:#7fc9ff;--ring:#ffd7e6;
  --shadow:0 12px 28px rgba(0,0,0,.08);
  --radius:22px;--danger:#ff5b6a;--ok:#2ecc71;
  --card:rgba(255,255,255,.92);--line:rgba(0,0,0,.08);
}
*{box-sizing:border-box}
html,body{height:100%}
body{
  margin:0;
  font-family:"Hiragino Kaku Gothic ProN","Noto Sans JP",system-ui;
  background:
    radial-gradient(1200px 600px at 15% 10%, rgba(255,121,166,.14), transparent 55%),
    radial-gradient(900px 500px at 85% 20%, rgba(127,201,255,.16), transparent 60%),
    linear-gradient(180deg,var(--bg),#fff);
  color:var(--ink)
}
a{color:inherit;text-decoration:none}
a:focus-visible,button:focus-visible,input:focus-visible,select:focus-visible,textarea:focus-visible{
  outline:3px solid rgba(255,121,166,.35);
  outline-offset:3px;
  border-radius:14px;
}

.wrap{max-width:980px;margin:0 auto;padding:18px 14px 26px}

/* header */
header{
  display:flex;justify-content:space-between;align-items:flex-end;gap:12px;margin-bottom:14px;flex-wrap:wrap
}
h1{margin:0;font-size:22px}
.sub{font-size:13px;color:var(--sub);margin-top:6px;line-height:1.5}
.badge{
  font-size:12px;padding:7px 10px;border-radius:999px;background:rgba(255,255,255,.75);
  border:1px solid rgba(255,121,166,.22);color:#b34a6a;white-space:nowrap
}

/* toolbar */
.toolbar{
  display:flex;gap:10px;flex-wrap:wrap;
  background:rgba(255,255,255,.9);
  border:1px solid var(--ring);
  border-radius:20px;padding:12px;
  box-shadow:var(--shadow);
  margin-bottom:14px;
  align-items:center;
}
select,input{
  padding:10px 12px;border-radius:14px;border:1px solid #ddd;
  font-size:14px;font-family:inherit;background:#fff
}
input{min-width:220px; flex:1}
.btn{
  padding:10px 12px;border-radius:14px;border:1px solid rgba(255,121,166,.25);
  background:#fff;font-weight:1000;cursor:pointer;
  transition:transform .08s ease, box-shadow .15s ease, border-color .15s ease;
  box-shadow:0 10px 22px rgba(0,0,0,.05);
}
.btn:hover{transform:translateY(-1px); box-shadow:0 14px 24px rgba(0,0,0,.08); border-color:rgba(255,121,166,.35)}
.btn:active{transform:translateY(0)}
.btn.primary{border:none;color:#fff;background:linear-gradient(135deg,var(--accent),var(--accent2))}
.btn.ghost{border-color:rgba(0,0,0,.10)}
.chipBtn{
  display:inline-flex; align-items:center; gap:8px;
  padding:10px 12px;border-radius:999px;
  border:1px solid rgba(0,0,0,.08);
  background:rgba(255,255,255,.9);
  font-weight:1000; cursor:pointer;
}
.chipBtn.on{
  border-color:rgba(127,201,255,.42);
  background:linear-gradient(135deg, rgba(127,201,255,.18), rgba(255,121,166,.10));
}

/* ★追加：削除バー */
.delbar{
  display:flex; gap:10px; flex-wrap:wrap;
  background:rgba(255,255,255,.9);
  border:1px dashed rgba(255,91,106,.35);
  border-radius:20px;
  padding:12px;
  box-shadow:0 12px 28px rgba(0,0,0,.05);
  margin-bottom:14px;
  align-items:center;
}
.delbar .hint{
  font-size:12px;color:#7a6a70;line-height:1.5;
  flex: 1 1 260px;
}
.delbar input{
  min-width:210px;
}
.delbar .btn.danger{
  border-color:rgba(255,91,106,.35);
  color:#a51d2c;
  background:rgba(255,91,106,.08);
}
.note{
  font-size:12px;color:#8a8086;line-height:1.6;
  margin:-6px 0 14px;
  padding:10px 12px;
  border-radius:16px;
  border:1px solid rgba(0,0,0,.06);
  background:rgba(255,255,255,.75);
}

/* grid/cards */
.grid{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:12px}
@media (max-width:820px){.grid{grid-template-columns:1fr}}
.card{
  background:var(--card);
  border:1px solid rgba(0,0,0,.06);
  border-radius:var(--radius);
  padding:14px;
  box-shadow:0 10px 22px rgba(0,0,0,.06);
  position:relative;
  overflow:hidden;
}
.card.mine{
  border-color:rgba(127,201,255,.35);
  box-shadow:0 14px 28px rgba(127,201,255,.10), 0 10px 22px rgba(0,0,0,.05);
}
.card.mine::before{
  content:"";
  position:absolute; left:0; top:0; bottom:0;
  width:6px;
  background:linear-gradient(180deg, rgba(127,201,255,.85), rgba(255,121,166,.25));
}
.top{display:flex;justify-content:space-between;gap:10px;align-items:flex-start}
.id{font-weight:1000;font-size:13px;letter-spacing:.02em}
.status{
  font-size:12px;font-weight:1000;padding:7px 10px;border-radius:999px;
  border:1px solid rgba(0,0,0,.06);background:#fff;white-space:nowrap
}
.status.open{color:#0d7a33;border-color:rgba(46,204,113,.35);background:rgba(46,204,113,.08)}
.status.closed{color:#a51d2c;border-color:rgba(255,91,106,.35);background:rgba(255,91,106,.10)}

.meta{margin-top:8px;font-size:13px;color:var(--sub);line-height:1.7}
.meta b{color:var(--ink)}
.comment{
  margin-top:10px;padding:10px 12px;border-radius:16px;
  background:rgba(255,121,166,.06);
  border:1px solid rgba(255,121,166,.15);
  font-size:13px;line-height:1.6
}
.comment.blue{
  background:rgba(127,201,255,.10);
  border-color:rgba(127,201,255,.22);
}
.actions{display:flex;gap:8px;flex-wrap:wrap;margin-top:12px}
.smallbtn{
  padding:9px 10px;border-radius:14px;border:1px solid rgba(0,0,0,.08);
  background:#fff;font-weight:1000;cursor:pointer;font-size:13px;
  text-decoration:none;display:inline-flex;align-items:center;gap:8px;
}
.smallbtn.join{border:none;color:#fff;background:linear-gradient(135deg,var(--accent),var(--accent2))}
.smallbtn.danger{border-color:rgba(255,91,106,.35);color:#a51d2c;background:rgba(255,91,106,.08)}
.smallbtn.muted{opacity:.65; cursor:not-allowed}
.small{font-size:12px;color:#999}
.empty{
  padding:16px;border-radius:22px;border:1px dashed rgba(0,0,0,.18);
  background:rgba(255,255,255,.7);color:#666;text-align:center
}
.back{margin-top:16px;text-align:center}
.back a{font-size:13px;color:#888;text-decoration:none}
hr.sep{border:none;border-top:1px dashed rgba(0,0,0,.12);margin:10px 0}

/* modal */
.modal{
  position:fixed; inset:0;
  background:rgba(0,0,0,.42);
  display:none;
  align-items:center; justify-content:center;
  padding:18px;
  z-index:50;
}
.modal .box{
  width:min(560px,100%);
  background:#fff;
  border-radius:22px;
  padding:14px;
  border:1px solid rgba(0,0,0,.10);
  box-shadow:0 22px 40px rgba(0,0,0,.18);
}
.mHead{
  display:flex; align-items:flex-start; justify-content:space-between; gap:10px;
  margin-bottom:8px;
}
.mHead h2{margin:0;font-size:16px}
.mClose{
  border:1px solid rgba(0,0,0,.10);
  background:#fff;
  border-radius:14px;
  padding:8px 10px;
  cursor:pointer;
  font-weight:1000;
}
.mBody{display:grid; gap:10px; margin-top:10px}
.field label{
  display:block; font-weight:1000; font-size:12px; color:#5d5258; margin-bottom:6px;
}
.field input,.field select,.field textarea{
  width:100%;
  padding:12px;
  border-radius:14px;
  border:1px solid #ddd;
  font-size:14px;
  font-family:inherit;
  background:#fff;
}
.field textarea{min-height:92px; resize:vertical}
.row2{display:grid; grid-template-columns:1fr 1fr; gap:10px}
@media (max-width:640px){.row2{grid-template-columns:1fr}}
.mFoot{
  display:flex; gap:10px; flex-wrap:wrap;
  margin-top:12px;
  justify-content:flex-end;
}
.mFoot .btn{box-shadow:none}
.warn{
  font-size:12px; color:#7a6a70; line-height:1.6;
  border:1px solid rgba(0,0,0,.06);
  background:rgba(255,255,255,.75);
  border-radius:14px;
  padding:10px 12px;
}
kbd{
  font-family:ui-monospace, SFMono-Regular, Menlo, Consolas, monospace;
  font-size:12px; background:rgba(0,0,0,.04); border:1px solid rgba(0,0,0,.08);
  padding:2px 6px; border-radius:8px;
}

/* ★追加：削除キー確認モーダル */
.modal2{
  position:fixed; inset:0;
  background:rgba(0,0,0,.42);
  display:none;
  align-items:center; justify-content:center;
  padding:18px;
  z-index:60;
}
.modal2 .box{
  width:min(520px,100%);
  background:#fff;
  border-radius:22px;
  padding:14px;
  border:1px solid rgba(0,0,0,.10);
  box-shadow:0 22px 40px rgba(0,0,0,.18);
}
.kTitle{margin:0;font-size:16px}
.kSub{font-size:12px;color:#7a6a70;line-height:1.6;margin-top:6px}
.kRow{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-top:12px}
@media (max-width:640px){.kRow{grid-template-columns:1fr}}
.kFoot{display:flex;gap:10px;flex-wrap:wrap;justify-content:flex-end;margin-top:12px}
</style>
</head>

<body>
<div class="wrap">
  <header>
    <div>
      <h1>面子募集の部屋を見る</h1>
      <div class="sub">作成者は「編集」「削除」ができます（あなたの部屋には目印がつきます）</div>
    </div>
    <div class="badge">PO・TORO / Mahjong</div>
  </header>

  <div class="toolbar">
    <select id="filterStatus" aria-label="状態フィルタ">
      <option value="all">すべて</option>
      <option value="open">募集中のみ</option>
      <option value="closed">締切済みのみ</option>
    </select>

    <button class="chipBtn" type="button" id="mineOnly" aria-pressed="false" title="自分が作成した部屋だけ表示">
      自分の部屋だけ
    </button>

    <input id="q" type="text" placeholder="検索（作成者名 / ID / ひとこと）" />

    <button class="btn ghost" type="button" id="btnRefresh">更新</button>
    <button class="btn primary" type="button" onclick="location.href='mahjong-room-create.html'">部屋を作成</button>
  </div>

  <!-- ★追加：一覧ページから削除（部屋ID＋4桁キー） -->
  <div class="delbar" aria-label="削除バー">
    <div class="hint">
      <b style="color:#a51d2c">部屋の削除（4桁削除キー）</b><br>
      部屋IDと削除キーが一致すると削除できます。
    </div>
    <input id="delRoomId" type="text" placeholder="部屋ID（例：RM-240101-1900-ABCD）" aria-label="削除する部屋ID" />
    <input id="delKey" type="password" inputmode="numeric" maxlength="4" placeholder="削除キー（4桁）" aria-label="削除キー（4桁）" autocomplete="off" />
    <button class="btn danger" type="button" id="btnDeleteByKey">削除</button>
  </div>
  <div class="note">
    ※削除キーは Firestore に「ハッシュ」で保存されている前提です（部屋作成ページで登録した方式）。<br>
    ※削除は取り消せません。
  </div>

  <div id="list" class="grid"></div>

  <div class="back">
    <a href="mahjong-lobby.html">← 面子募集トップへ戻る</a>
  </div>
</div>

<!-- 編集モーダル（作成者のみ） -->
<div class="modal" id="editModal" role="dialog" aria-modal="true" aria-label="部屋の編集">
  <div class="box">
    <div class="mHead">
      <div>
        <h2>募集内容の編集</h2>
        <div class="small">部屋ID：<span id="mRoomId" style="font-weight:1000"></span></div>
      </div>
      <button class="mClose" type="button" id="mClose">閉じる</button>
    </div>

    <div class="warn">
      <b>注意</b><br>
      ・編集できるのは <b>作成者のみ</b> です。<br>
      ・<b>開始日時</b> または <b>利用時間</b> を変えると、終了予定も自動で更新します。<br>
      ・人数（募集）を参加数より小さくした場合は、内部で整合を取ります（参加数に丸めます）。
    </div>

    <div class="mBody">
      <div class="row2">
        <div class="field">
          <label for="fRule">形式（例：4人打ち / 3人打ち）</label>
          <input id="fRule" placeholder="例：4人打ち（東風）" maxlength="40" />
        </div>
        <div class="field">
          <label for="fSlots">募集人数（slotsTotal）</label>
          <input id="fSlots" type="number" min="1" max="9" step="1" />
        </div>
      </div>

      <div class="row2">
        <div class="field">
          <label for="fEventAt">開始日時</label>
          <input id="fEventAt" type="datetime-local" />
        </div>
        <div class="field">
          <label for="fDuration">利用時間（分）</label>
          <select id="fDuration">
            <option value="120">2時間</option>
            <option value="150">2時間30分</option>
            <option value="180">3時間</option>
            <option value="210">3時間30分</option>
            <option value="240">4時間</option>
            <option value="270">4時間30分</option>
            <option value="300">5時間</option>
          </select>
        </div>
      </div>

      <div class="row2">
        <div class="field">
          <label for="fDeadlineAt">締切日時</label>
          <input id="fDeadlineAt" type="datetime-local" />
        </div>
        <div class="field">
          <label for="fClosed">手動締切（closed）</label>
          <select id="fClosed">
            <option value="auto">自動（締切/満員で自動締切）</option>
            <option value="open">手動で開放（closed=false）</option>
            <option value="closed">手動で締切（closed=true）</option>
          </select>
        </div>
      </div>

      <div class="field">
        <label for="fComment">ひとこと（募集コメント）</label>
        <textarea id="fComment" maxlength="200" placeholder="例：初心者歓迎です！19:00にお屋敷集合でお願いします。"></textarea>
        <div class="small">※200文字まで</div>
      </div>
    </div>

    <div class="mFoot">
      <button class="btn" type="button" id="mCopyLink">チャットURLをコピー</button>
      <!-- ★ここは「キー削除」が主なので、作成者削除ボタンは残すが、キー入力モーダルを開く挙動に変更 -->
      <button class="btn dangerBtn btn" type="button" id="mDelete"
        style="border-color:rgba(255,91,106,.35); color:#a51d2c; background:rgba(255,91,106,.08)">
        この部屋を削除
      </button>
      <button class="btn primary" type="button" id="mSave">変更を保存</button>
    </div>

    <div class="small" style="margin-top:10px; color:#8a8086; line-height:1.6">
      ヒント：検索は即時反映です。自分の部屋だけ見たい時は上の <kbd>自分の部屋だけ</kbd> をONに。
    </div>
  </div>
</div>

<!-- ★追加：削除キー入力モーダル（カードの削除ボタン/編集モーダル削除からも利用） -->
<div class="modal2" id="keyModal" role="dialog" aria-modal="true" aria-label="削除キーの入力">
  <div class="box">
    <div class="mHead" style="margin-bottom:0">
      <div>
        <h3 class="kTitle">削除キーを入力</h3>
        <div class="kSub">部屋ID：<span id="kRoomId" style="font-weight:1000"></span></div>
      </div>
      <button class="mClose" type="button" id="kClose">閉じる</button>
    </div>

    <div class="kRow">
      <div class="field" style="margin:0">
        <label for="kKey">削除キー（4桁）</label>
        <input id="kKey" type="password" inputmode="numeric" maxlength="4" placeholder="例：1234" autocomplete="off" />
        <div class="small">※一致しない場合は削除できません</div>
      </div>

      <div class="warn" style="margin:0">
        <b>注意</b><br>
        ・削除は取り消せません。<br>
        ・キーは Firestore に「ハッシュ」で保存されている前提です。<br>
        ・古い部屋（deleteKeyHash未登録）は削除できません。
      </div>
    </div>

    <div class="kFoot">
      <button class="btn" type="button" id="kCancel">キャンセル</button>
      <button class="btn danger" type="button" id="kDoDelete"
        style="border-color:rgba(255,91,106,.35); color:#a51d2c; background:rgba(255,91,106,.08)">
        削除する
      </button>
    </div>
  </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";
import {
  getFirestore, collection, onSnapshot, query, orderBy,
  doc, runTransaction, deleteDoc, updateDoc, Timestamp, getDoc
} from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

/** ここをFirebase Consoleの値に置換 */
const firebaseConfig = {
  apiKey: "AIzaSyAm1EIxmK_UWmRM7VMP7LREbMQhSYmylko",
  authDomain: "potoro-mahjong.firebaseapp.com",
  projectId: "potoro-mahjong",
  storageBucket: "potoro-mahjong.firebasestorage.app",
  messagingSenderId: "467297785940",
  appId: "1:467297785940:web:b1a0ed4cfa5ecd29a575c1",
  measurementId: "G-KTFZDLG5TL"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

let currentUid = null;
onAuthStateChanged(auth, (u)=>{ if(u) currentUid = u.uid; });
signInAnonymously(auth).catch(()=>alert("Firebase認証に失敗しました（Anonymous Authを有効化してください）"));

const $ = (id)=>document.getElementById(id);
const list = $("list");

/* ===== util ===== */
function pad(n){ return String(n).padStart(2,"0"); }
function tsToLabel(ts){
  const d = ts.toDate();
  const w = ["日","月","火","水","木","金","土"][d.getDay()];
  return `${d.getFullYear()}/${pad(d.getMonth()+1)}/${pad(d.getDate())}(${w}) ${pad(d.getHours())}:${pad(d.getMinutes())}`;
}
function formatDurationMinutes(min){
  const m = Number(min);
  if(!Number.isFinite(m) || m <= 0) return "—";
  const h = Math.floor(m/60);
  const mm = m%60;
  return mm === 0 ? `${h}時間` : `${h}時間30分`;
}
function remainingSlots(r){ return Math.max(0, (r.slotsTotal|0) - (r.joinedCount|0)); }
function computeClosed(r){
  const now = Date.now();
  const deadline = r.deadlineAt?.toDate?.().getTime?.() ?? 0;
  if(r.closed) return true;
  if(now > deadline) return true;
  if(remainingSlots(r) <= 0) return true;
  return false;
}
function escapeHtml(str){
  return String(str)
    .replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;")
    .replaceAll('"',"&quot;").replaceAll("'","&#39;");
}
function toLocalInputValueFromDate(d){
  const yyyy = d.getFullYear();
  const mm = pad(d.getMonth()+1);
  const dd = pad(d.getDate());
  const hh = pad(d.getHours());
  const mi = pad(d.getMinutes());
  return `${yyyy}-${mm}-${dd}T${hh}:${mi}`;
}
function parseLocalInputToDate(value){
  const d = new Date(value);
  return isNaN(d.getTime()) ? null : d;
}
function computeEndAt(eventAtDate, durationMinutes){
  const ms = Number(durationMinutes) * 60 * 1000;
  return new Date(eventAtDate.getTime() + ms);
}

/* ★追加：4桁キー検証 */
function is4DigitNumber(s){ return /^\d{4}$/.test(String(s||"").trim()); }
async function sha256Hex(text){
  const enc = new TextEncoder().encode(text);
  const buf = await crypto.subtle.digest("SHA-256", enc);
  return [...new Uint8Array(buf)].map(b => b.toString(16).padStart(2,"0")).join("");
}

/* ===== state ===== */
let latestRooms = [];
let mineOnly = false;

/* ===== render ===== */
function render(){
  let rooms = [...latestRooms];

  if(mineOnly && currentUid){
    rooms = rooms.filter(r => r.creatorUid === currentUid);
  }

  const q = ($("q").value || "").trim().toLowerCase();
  if(q){
    rooms = rooms.filter(r=>{
      const hay = `${r.id} ${r.creatorName||""} ${r.comment||""}`.toLowerCase();
      return hay.includes(q);
    });
  }

  const f = $("filterStatus").value;
  if(f==="open") rooms = rooms.filter(r=>!computeClosed(r));
  if(f==="closed") rooms = rooms.filter(r=>computeClosed(r));

  if(rooms.length===0){
    list.innerHTML = `<div class="empty">表示できる部屋がありません。<br><span class="small">「部屋を作成」から募集を作れます。</span></div>`;
    return;
  }

  list.innerHTML = rooms.map(r=>{
    const closed = computeClosed(r);
    const rem = remainingSlots(r);
    const statusText = closed ? "締切済み / 満員" : "募集中";
    const statusClass = closed ? "closed" : "open";

    const now = Date.now();
    const dl = r.deadlineAt.toDate().getTime();
    const dlText = now > dl
      ? "締切：過ぎています"
      : (()=> {
          const mins = Math.ceil((dl - now)/60000);
          const h = Math.floor(mins/60);
          const m = mins%60;
          return `締切：あと ${h>0?`${h}時間`:""}${m}分`;
        })();

    const comment = (r.comment||"").trim() || "（ひとこと未設定）";
    const durationText = formatDurationMinutes(r.durationMinutes);
    const endAtText = r.endAt ? tsToLabel(r.endAt) : "—";
    const timeRange = `${tsToLabel(r.eventAt)} 〜 ${endAtText}`;

    const isMine = (currentUid && r.creatorUid === currentUid);

    return `
      <div class="card ${isMine ? "mine" : ""}">
        <div class="top">
          <div class="id">${escapeHtml(r.id)} ${isMine ? `<span class="small" style="margin-left:8px; font-weight:1000; color:#2b4a62">あなたの部屋</span>` : ""}</div>
          <div class="status ${statusClass}">${statusText}</div>
        </div>

        <div class="meta">
          <div><b>作成者：</b>${escapeHtml(r.creatorName||"")}</div>
          <div><b>形式：</b>${escapeHtml(r.rule||"")}　<b>利用時間：</b>${escapeHtml(durationText)}</div>
          <div><b>時間：</b>${escapeHtml(timeRange)}</div>
          <hr class="sep">
          <div><b>募集：</b>${r.slotsTotal}名　<b>参加：</b>${r.joinedCount}名　<b>残り：</b>${rem}名</div>
          <div class="small">${tsToLabel(r.deadlineAt)}（${dlText}）</div>
        </div>

        <div class="comment ${isMine ? "blue" : ""}">${escapeHtml(comment)}</div>

        <div class="actions">
          ${closed ? "" : `<button class="smallbtn join" data-act="join" data-id="${escapeHtml(r.id)}">参加する（+1）</button>`}
          <button class="smallbtn" data-act="cancel" data-id="${escapeHtml(r.id)}">キャンセル（-1）</button>
          <a class="smallbtn" href="mahjong-room-chat.html?id=${encodeURIComponent(r.id)}">チャットへ</a>
          ${isMine ? `<button class="smallbtn" data-act="edit" data-id="${escapeHtml(r.id)}">編集</button>` : ""}

          <!-- ★変更：削除は「キー入力モーダル」へ（作成者限定を外してもOKだが、UI上は自分の部屋に表示） -->
          ${isMine ? `<button class="smallbtn danger" data-act="deleteKey" data-id="${escapeHtml(r.id)}">削除（キー）</button>` : ""}

          <!-- 作成者じゃなくても「部屋ID＋キー」で消したい場合は↓を有効化
          <button class="smallbtn danger" data-act="deleteKey" data-id="${escapeHtml(r.id)}">削除（キー）</button>
          -->
        </div>

        <div class="small">※締切超過 or 残り0で自動的に締切扱いになります。</div>
      </div>
    `;
  }).join("");
}

/* ===== join/cancel transaction ===== */
async function txUpdateCount(roomId, delta){
  if(!currentUid){ alert("認証中です。"); return; }

  const ref = doc(db, "rooms", roomId);
  try{
    await runTransaction(db, async (tx)=>{
      const snap = await tx.get(ref);
      if(!snap.exists()) throw new Error("room_not_found");
      const r = snap.data();

      const now = Date.now();
      const dl = r.deadlineAt.toDate().getTime();
      const rem = Math.max(0, (r.slotsTotal|0) - (r.joinedCount|0));
      const closed = r.closed || now > dl || rem <= 0;
      if(delta > 0 && closed) throw new Error("closed");

      let next = (r.joinedCount|0) + delta;
      if(next < 0) next = 0;
      if(next > r.slotsTotal) next = r.slotsTotal;

      const nextClosed = (now > dl) || (Math.max(0, r.slotsTotal - next) <= 0);

      tx.update(ref, { joinedCount: next, closed: nextClosed });
    });
  }catch(e){
    console.error(e);
    if(String(e.message).includes("closed")) alert("この部屋は締切済みです。");
    else alert("更新に失敗しました。");
  }
}

/* ===== ★追加：削除（部屋ID＋4桁キー） ===== */
async function deleteRoomWithKey(roomId, key){
  if(!currentUid){ alert("認証中です。"); return; }
  if(!roomId){ alert("部屋IDを入力してください。"); return; }
  if(!is4DigitNumber(key)){ alert("削除キーは4桁の数字で入力してください。"); return; }

  const ref = doc(db, "rooms", roomId);

  try{
    const snap = await getDoc(ref);
    if(!snap.exists()){ alert("部屋が見つかりません。部屋IDをご確認ください。"); return; }

    const data = snap.data() || {};
    if(!data.deleteKeyHash){
      alert("この部屋は削除キー未対応（deleteKeyHash未登録）です。");
      return;
    }

    const hash = await sha256Hex(key);
    if(hash !== data.deleteKeyHash){
      alert("削除キーが違います。");
      return;
    }

    const ok = confirm(`本当に削除しますか？\n\n部屋ID：${roomId}\n※削除は取り消せません。`);
    if(!ok) return;

    await deleteDoc(ref);
    alert("部屋を削除しました。");

    // UI上の入力欄も掃除
    if($("delRoomId")) $("delRoomId").value = "";
    if($("delKey")) $("delKey").value = "";
    if($("kKey")) $("kKey").value = "";
    closeKeyModal();
  }catch(e){
    console.error(e);
    alert("削除に失敗しました。Firestoreルール/権限を確認してください。");
  }
}

/* ===== edit modal ===== */
let editingRoomId = null;
let editingRoom = null;

function openEditModal(room){
  editingRoom = room;
  editingRoomId = room.id;

  $("mRoomId").textContent = room.id;

  $("fRule").value = room.rule || "";
  $("fSlots").value = String(room.slotsTotal ?? 4);

  try{ $("fEventAt").value = toLocalInputValueFromDate(room.eventAt.toDate()); }catch{ $("fEventAt").value = ""; }
  $("fDuration").value = String(room.durationMinutes ?? 180);
  try{ $("fDeadlineAt").value = toLocalInputValueFromDate(room.deadlineAt.toDate()); }catch{ $("fDeadlineAt").value = ""; }

  if(room.closed === true) $("fClosed").value = "closed";
  else $("fClosed").value = "auto";

  $("fComment").value = room.comment || "";

  $("editModal").style.display = "flex";
}
function closeEditModal(){
  $("editModal").style.display = "none";
  editingRoomId = null;
  editingRoom = null;
}
$("mClose").addEventListener("click", closeEditModal);
$("editModal").addEventListener("click", (e)=>{ if(e.target === $("editModal")) closeEditModal(); });

$("mCopyLink").addEventListener("click", async ()=>{
  if(!editingRoomId) return;
  const url = `${location.origin}${location.pathname.replace(/[^/]*$/, "")}mahjong-room-chat.html?id=${encodeURIComponent(editingRoomId)}`;
  try{
    await navigator.clipboard.writeText(url);
    alert("チャットURLをコピーしました。");
  }catch{
    prompt("コピーできない場合はこのURLをコピーしてください。", url);
  }
});

/* ★変更：編集モーダルの削除ボタン → キー入力モーダルを開く */
$("mDelete").addEventListener("click", ()=>{
  if(!editingRoomId) return;
  // 編集画面は閉じて、キー入力へ
  closeEditModal();
  openKeyModal(editingRoomId);
});

$("mSave").addEventListener("click", async ()=>{
  if(!editingRoomId || !editingRoom) return;
  if(!currentUid){ alert("認証中です。"); return; }
  if(editingRoom.creatorUid !== currentUid){
    alert("作成者ではないため編集できません。");
    return;
  }

  const rule = $("fRule").value.trim().slice(0,40);
  const slotsTotal = Math.max(1, Math.min(9, Number($("fSlots").value || 4)));
  const eventAtD = parseLocalInputToDate($("fEventAt").value);
  const durationMinutes = Number($("fDuration").value || 180);
  const deadlineAtD = parseLocalInputToDate($("fDeadlineAt").value);
  const comment = $("fComment").value.trim().slice(0,200);

  if(!eventAtD){ alert("開始日時を入力してください。"); return; }
  if(!deadlineAtD){ alert("締切日時を入力してください。"); return; }

  const endAtD = computeEndAt(eventAtD, durationMinutes);

  const closedSel = $("fClosed").value;
  let closedValue = undefined;
  if(closedSel === "closed") closedValue = true;
  if(closedSel === "open") closedValue = false;

  const joinedCount = Number(editingRoom.joinedCount || 0);
  const nextJoined = Math.min(joinedCount, slotsTotal);

  const now = Date.now();
  const nextRem = Math.max(0, slotsTotal - nextJoined);
  const autoClosed = (now > deadlineAtD.getTime()) || (nextRem <= 0);
  const finalClosed = (closedValue === undefined) ? autoClosed : closedValue;

  try{
    await updateDoc(doc(db, "rooms", editingRoomId), {
      rule,
      slotsTotal,
      durationMinutes,
      comment,
      eventAt: Timestamp.fromDate(eventAtD),
      endAt: Timestamp.fromDate(endAtD),
      deadlineAt: Timestamp.fromDate(deadlineAtD),
      joinedCount: nextJoined,
      closed: finalClosed
    });
    alert("更新しました。");
    closeEditModal();
  }catch(e){
    console.error(e);
    alert("更新に失敗しました。Firestoreルール/権限を確認してください。");
  }
});

/* ===== ★追加：削除キー入力モーダル制御 ===== */
let keyTargetRoomId = null;

function openKeyModal(roomId){
  keyTargetRoomId = roomId;
  $("kRoomId").textContent = roomId;
  $("kKey").value = "";
  $("keyModal").style.display = "flex";
  setTimeout(()=>{ $("kKey").focus(); }, 50);
}
function closeKeyModal(){
  $("keyModal").style.display = "none";
  keyTargetRoomId = null;
}
$("kClose").addEventListener("click", closeKeyModal);
$("kCancel").addEventListener("click", closeKeyModal);
$("keyModal").addEventListener("click", (e)=>{ if(e.target === $("keyModal")) closeKeyModal(); });

$("kDoDelete").addEventListener("click", async ()=>{
  if(!keyTargetRoomId) return;
  const key = $("kKey").value.trim();
  await deleteRoomWithKey(keyTargetRoomId, key);
});

/* ===== events ===== */
list.addEventListener("click", (ev)=>{
  const btn = ev.target.closest("[data-act]");
  if(!btn) return;
  const act = btn.dataset.act;
  const roomId = btn.dataset.id;

  if(act==="join") txUpdateCount(roomId, +1);
  if(act==="cancel") {
    if(confirm("参加数を -1 しますか？")) txUpdateCount(roomId, -1);
  }
  if(act==="edit"){
    const room = latestRooms.find(r => r.id === roomId);
    if(!room){ alert("部屋情報の取得に失敗しました。"); return; }
    if(room.creatorUid !== currentUid){ alert("作成者ではないため編集できません。"); return; }
    openEditModal(room);
  }
  if(act==="deleteKey"){
    // 作成者限定のままにするなら上で isMine のときだけボタンが出る
    openKeyModal(roomId);
  }
});

$("filterStatus").addEventListener("change", render);
$("q").addEventListener("input", render);
$("btnRefresh").addEventListener("click", render);

$("mineOnly").addEventListener("click", ()=>{
  mineOnly = !mineOnly;
  $("mineOnly").classList.toggle("on", mineOnly);
  $("mineOnly").setAttribute("aria-pressed", mineOnly ? "true" : "false");
  render();
});

/* ★追加：上部削除バーの削除ボタン */
$("btnDeleteByKey").addEventListener("click", async ()=>{
  const roomId = $("delRoomId").value.trim();
  const key = $("delKey").value.trim();
  await deleteRoomWithKey(roomId, key);
});

// Enterで削除（便利）
$("delKey").addEventListener("keydown", (e)=>{
  if(e.key === "Enter"){
    e.preventDefault();
    $("btnDeleteByKey").click();
  }
});

/* ===== realtime subscribe ===== */
const qRooms = query(collection(db, "rooms"), orderBy("eventAt", "asc"));
onSnapshot(qRooms, (snap)=>{
  latestRooms = snap.docs.map(d=>d.data());
  render();
});
</script>
</body>
</html>
