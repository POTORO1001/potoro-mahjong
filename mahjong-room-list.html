<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>PO・TORO｜面子募集の部屋を見る</title>
<meta name="theme-color" content="#f6b7d2" />
<style>
:root{
  --bg:#fff7fb;--ink:#2b2b2b;--sub:#666;
  --accent:#ff79a6;--accent2:#7fc9ff;--ring:#ffd7e6;
  --shadow:0 12px 28px rgba(0,0,0,.08);
  --radius:22px;--danger:#ff5b6a;--ok:#2ecc71;
  --card:rgba(255,255,255,.92);--line:rgba(0,0,0,.08);
}
*{box-sizing:border-box}
html,body{height:100%}
body{
  margin:0;
  font-family:"Hiragino Kaku Gothic ProN","Noto Sans JP",system-ui;
  background:
    radial-gradient(1200px 600px at 15% 10%, rgba(255,121,166,.14), transparent 55%),
    radial-gradient(900px 500px at 85% 20%, rgba(127,201,255,.16), transparent 60%),
    linear-gradient(180deg,var(--bg),#fff);
  color:var(--ink)
}
a{color:inherit;text-decoration:none}
a:focus-visible,button:focus-visible,input:focus-visible,select:focus-visible,textarea:focus-visible{
  outline:3px solid rgba(255,121,166,.35);
  outline-offset:3px;
  border-radius:14px;
}

.wrap{max-width:980px;margin:0 auto;padding:18px 14px 26px}

/* header */
header{
  display:flex;justify-content:space-between;align-items:flex-end;gap:12px;margin-bottom:14px;flex-wrap:wrap
}
h1{margin:0;font-size:22px}
.sub{font-size:13px;color:var(--sub);margin-top:6px;line-height:1.5}
.badge{
  font-size:12px;padding:7px 10px;border-radius:999px;background:rgba(255,255,255,.75);
  border:1px solid rgba(255,121,166,.22);color:#b34a6a;white-space:nowrap
}

/* toolbar */
.toolbar{
  display:flex;gap:10px;flex-wrap:wrap;
  background:rgba(255,255,255,.9);
  border:1px solid var(--ring);
  border-radius:20px;padding:12px;
  box-shadow:var(--shadow);
  margin-bottom:14px;
  align-items:center;
}
select,input{
  padding:10px 12px;border-radius:14px;border:1px solid #ddd;
  font-size:14px;font-family:inherit;background:#fff
}
input{min-width:220px; flex:1}
.btn{
  padding:10px 12px;border-radius:14px;border:1px solid rgba(255,121,166,.25);
  background:#fff;font-weight:1000;cursor:pointer;
  transition:transform .08s ease, box-shadow .15s ease, border-color .15s ease;
  box-shadow:0 10px 22px rgba(0,0,0,.05);
}
.btn:hover{transform:translateY(-1px); box-shadow:0 14px 24px rgba(0,0,0,.08); border-color:rgba(255,121,166,.35)}
.btn:active{transform:translateY(0)}
.btn.primary{border:none;color:#fff;background:linear-gradient(135deg,var(--accent),var(--accent2))}
.btn.ghost{border-color:rgba(0,0,0,.10)}
.chipBtn{
  display:inline-flex; align-items:center; gap:8px;
  padding:10px 12px;border-radius:999px;
  border:1px solid rgba(0,0,0,.08);
  background:rgba(255,255,255,.9);
  font-weight:1000; cursor:pointer;
}
.chipBtn.on{
  border-color:rgba(127,201,255,.42);
  background:linear-gradient(135deg, rgba(127,201,255,.18), rgba(255,121,166,.10));
}

/* delbar */
.delbar{
  display:flex; gap:10px; flex-wrap:wrap;
  background:rgba(255,255,255,.9);
  border:1px dashed rgba(255,91,106,.35);
  border-radius:20px;
  padding:12px;
  box-shadow:0 12px 28px rgba(0,0,0,.05);
  margin-bottom:14px;
  align-items:center;
}
.delbar .hint{
  font-size:12px;color:#7a6a70;line-height:1.5;
  flex: 1 1 260px;
}
.delbar input{min-width:210px;}
.delbar .btn.danger{
  border-color:rgba(255,91,106,.35);
  color:#a51d2c;
  background:rgba(255,91,106,.08);
}
.note{
  font-size:12px;color:#8a8086;line-height:1.6;
  margin:-6px 0 14px;
  padding:10px 12px;
  border-radius:16px;
  border:1px solid rgba(0,0,0,.06);
  background:rgba(255,255,255,.75);
}

/* grid/cards */
.grid{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:12px}
@media (max-width:820px){.grid{grid-template-columns:1fr}}
.card{
  background:var(--card);
  border:1px solid rgba(0,0,0,.06);
  border-radius:var(--radius);
  padding:14px;
  box-shadow:0 10px 22px rgba(0,0,0,.06);
  position:relative;
  overflow:hidden;
}
.card.mine{
  border-color:rgba(127,201,255,.35);
  box-shadow:0 14px 28px rgba(127,201,255,.10), 0 10px 22px rgba(0,0,0,.05);
}
.card.mine::before{
  content:"";
  position:absolute; left:0; top:0; bottom:0;
  width:6px;
  background:linear-gradient(180deg, rgba(127,201,255,.85), rgba(255,121,166,.25));
}
.top{display:flex;justify-content:space-between;gap:10px;align-items:flex-start}
.id{font-weight:1000;font-size:13px;letter-spacing:.02em; display:flex; align-items:center; gap:8px; flex-wrap:wrap}
.kbd{font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace;font-weight:1000}
.copy{
  padding:6px 10px;border-radius:999px;border:1px solid rgba(255,121,166,.25);
  background:#fff; cursor:pointer; font-weight:1000; font-size:12px;
}
.status{
  font-size:12px;font-weight:1000;padding:7px 10px;border-radius:999px;
  border:1px solid rgba(0,0,0,.06);background:#fff;white-space:nowrap
}
.status.open{color:#0d7a33;border-color:rgba(46,204,113,.35);background:rgba(46,204,113,.08)}
.status.closed{color:#a51d2c;border-color:rgba(255,91,106,.35);background:rgba(255,91,106,.10)}

.meta{margin-top:8px;font-size:13px;color:var(--sub);line-height:1.7}
.meta b{color:var(--ink)}
.comment{
  margin-top:10px;padding:10px 12px;border-radius:16px;
  background:rgba(255,121,166,.06);
  border:1px solid rgba(255,121,166,.15);
  font-size:13px;line-height:1.6
}
.comment.blue{
  background:rgba(127,201,255,.10);
  border-color:rgba(127,201,255,.22);
}
.actions{display:flex;gap:8px;flex-wrap:wrap;margin-top:12px}
.smallbtn{
  padding:9px 10px;border-radius:14px;border:1px solid rgba(0,0,0,.08);
  background:#fff;font-weight:1000;cursor:pointer;font-size:13px;
  text-decoration:none;display:inline-flex;align-items:center;gap:8px;
}
.smallbtn.join{border:none;color:#fff;background:linear-gradient(135deg,var(--accent),var(--accent2))}
.smallbtn.ask{border-color:rgba(127,201,255,.35); background:rgba(127,201,255,.10); color:#2b4a62}
.smallbtn.danger{border-color:rgba(255,91,106,.35);color:#a51d2c;background:rgba(255,91,106,.08)}
.smallbtn.muted{opacity:.65; cursor:not-allowed}
.small{font-size:12px;color:#999}
.empty{
  padding:16px;border-radius:22px;border:1px dashed rgba(0,0,0,.18);
  background:rgba(255,255,255,.7);color:#666;text-align:center
}
.back{margin-top:16px;text-align:center}
.back a{font-size:13px;color:#888;text-decoration:none}
hr.sep{border:none;border-top:1px dashed rgba(0,0,0,.12);margin:10px 0}

/* modal (name) */
.modalN{
  position:fixed; inset:0;
  background:rgba(0,0,0,.42);
  display:none;
  align-items:center; justify-content:center;
  padding:18px;
  z-index:80;
}
.modalN .box{
  width:min(460px,100%);
  background:#fff;
  border-radius:22px;
  padding:14px;
  border:1px solid rgba(0,0,0,.10);
  box-shadow:0 22px 40px rgba(0,0,0,.18);
}
.modalN .head{display:flex;justify-content:space-between;gap:10px;align-items:flex-start}
.modalN h2{margin:0;font-size:16px}
.modalN .subt{margin-top:6px;font-size:12px;color:#7a6a70;line-height:1.6}
.modalN label{display:block;font-size:12px;font-weight:1000;color:#5d5258;margin:12px 0 6px}
.modalN input{width:100%;padding:12px;border-radius:14px;border:1px solid #ddd;font-size:14px}
.modalN .foot{display:flex;gap:10px;justify-content:flex-end;flex-wrap:wrap;margin-top:12px}
.modalN .btn{box-shadow:none}

/* ★ edit key modal */
.modalN .krow{display:flex; gap:10px; align-items:center; flex-wrap:wrap}
.modalN .krow input{flex:1}
.pill{
  display:inline-flex; align-items:center;
  font-size:12px; font-weight:1000;
  padding:6px 10px; border-radius:999px;
  background:rgba(127,201,255,.12);
  border:1px solid rgba(127,201,255,.25);
  color:#2b4a62;
}
.warn{
  font-size:12px; color:#8a4b55; line-height:1.6;
  background:rgba(255,91,106,.08);
  border:1px solid rgba(255,91,106,.18);
  padding:10px 12px; border-radius:16px;
  margin-top:10px;
}
</style>
</head>

<body>
<div class="wrap">
  <header>
    <div>
      <h1>面子募集の部屋を見る</h1>
      <div class="sub">作成者は「編集」「削除」ができます（あなたの部屋には目印がつきます）</div>
    </div>
    <div class="badge">PO・TORO / Mahjong</div>
  </header>

  <div class="toolbar">
    <select id="filterStatus" aria-label="状態フィルタ">
      <option value="all">すべて</option>
      <option value="open">募集中のみ</option>
      <option value="closed">締切済みのみ</option>
    </select>

    <button class="chipBtn" type="button" id="mineOnly" aria-pressed="false" title="自分が作成した部屋だけ表示">
      自分の部屋だけ
    </button>

    <input id="q" type="text" placeholder="検索（作成者名 / ID / ひとこと）" />

    <button class="btn ghost" type="button" id="btnRefresh">更新</button>
    <button class="btn primary" type="button" onclick="location.href='mahjong-room-create.html'">部屋を作成</button>
  </div>

  <div class="delbar" aria-label="削除バー">
    <div class="hint">
      <b style="color:#a51d2c">部屋の削除（4桁削除キー）</b><br>
      部屋IDと削除キーが一致すると削除できます。
    </div>
    <input id="delRoomId" type="text" placeholder="部屋ID（例：RM-240101-1900-ABCD）" aria-label="削除する部屋ID" />
    <input id="delKey" type="password" inputmode="numeric" maxlength="4" placeholder="削除キー（4桁）" aria-label="削除キー（4桁）" autocomplete="off" />
    <button class="btn danger" type="button" id="btnDeleteByKey">削除</button>
  </div>
  <div class="note">
    ※削除キーは Firestore に「ハッシュ」で保存されている前提です（部屋作成ページで登録した方式）。<br>
    ※削除は取り消せません。<br>
    ※編集も同じ削除キーで保護しています。
  </div>

  <div id="list" class="grid"></div>

  <div class="back">
    <a href="mahjong-lobby.html">← 面子募集トップへ戻る</a>
  </div>
</div>

<!-- ★参加（join）用：名前入力モーダル -->
<div class="modalN" id="joinNameModal" role="dialog" aria-modal="true" aria-label="参加の表示名入力">
  <div class="box">
    <div class="head">
      <div>
        <h2>参加する（表示名を入力）</h2>
        <div class="subt">参加者一覧に表示されます。質問だけの場合は「質問する」をご利用ください。</div>
      </div>
      <button class="btn ghost" type="button" id="jnClose">閉じる</button>
    </div>

    <label for="jnName">表示名（20文字まで）</label>
    <input id="jnName" maxlength="20" placeholder="例：ご主人様1234 / お嬢様ミント" />

    <div class="foot">
      <button class="btn ghost" type="button" id="jnCancel">キャンセル</button>
      <button class="btn primary" type="button" id="jnOk">この名前で参加</button>
    </div>
  </div>
</div>

<!-- ★編集（edit）用：削除キー入力モーダル -->
<div class="modalN" id="editKeyModal" role="dialog" aria-modal="true" aria-label="編集の削除キー入力">
  <div class="box">
    <div class="head">
      <div>
        <h2>編集する（削除キー確認）</h2>
        <div class="subt">
          <span class="pill">4桁削除キーを入力</span>
          一致した場合のみ編集画面へ進めます。
        </div>
      </div>
      <button class="btn ghost" type="button" id="ekClose">閉じる</button>
    </div>

    <label for="ekRoomId">部屋ID</label>
    <input id="ekRoomId" readonly />

    <label for="ekKey">削除キー（4桁）</label>
    <div class="krow">
      <input id="ekKey" type="password" inputmode="numeric" maxlength="4" placeholder="4桁の数字" autocomplete="off" />
      <button class="btn ghost" type="button" id="ekClear">クリア</button>
    </div>

    <div class="warn">
      ※キーはURLに載せません（ログ等に残る可能性があるため）。<br>
      ※認証OKの場合のみ「編集ページ」で操作できます。
    </div>

    <div class="foot">
      <button class="btn ghost" type="button" id="ekCancel">キャンセル</button>
      <button class="btn primary" type="button" id="ekOk">キーを確認して編集へ</button>
    </div>
  </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";
import {
  getFirestore, collection, onSnapshot, query, orderBy,
  doc, runTransaction, deleteDoc, getDoc
} from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyAm1EIxmK_UWmRM7VMP7LREbMQhSYmylko",
  authDomain: "potoro-mahjong.firebaseapp.com",
  projectId: "potoro-mahjong",
  storageBucket: "potoro-mahjong.firebasestorage.app",
  messagingSenderId: "467297785940",
  appId: "1:467297785940:web:b1a0ed4cfa5ecd29a575c1",
  measurementId: "G-KTFZDLG5TL"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

let currentUid = null;

/* ★重要：匿名認証が完了してから購読開始（rulesでreadにisSignedInが必要なため） */
let unsubscribeRooms = null;

onAuthStateChanged(auth, (u)=>{
  if(u){
    currentUid = u.uid;
    // 認証完了後に onSnapshot 開始（未開始なら）
    if(!unsubscribeRooms){
      startRoomsListener();
    }
  }
});

signInAnonymously(auth).catch(()=>alert("Firebase認証に失敗しました（Anonymous Authを有効化してください）"));

const $ = (id)=>document.getElementById(id);
const list = $("list");

/* ===== util ===== */
function pad(n){ return String(n).padStart(2,"0"); }
function tsToLabel(ts){
  const d = ts.toDate();
  const w = ["日","月","火","水","木","金","土"][d.getDay()];
  return `${d.getFullYear()}/${pad(d.getMonth()+1)}/${pad(d.getDate())}(${w}) ${pad(d.getHours())}:${pad(d.getMinutes())}`;
}

/* ★安定化：Timestamp欠けでも落ちない */
function toMs(ts){
  try{ return ts?.toDate?.().getTime?.() ?? 0; }catch{ return 0; }
}
function safeTsLabel(ts){
  const ms = toMs(ts);
  if(!ms) return "—";
  return tsToLabel(ts);
}

/* ★一般化：分→表示 */
function formatDurationMinutes(min){
  const m = Number(min);
  if(!Number.isFinite(m) || m <= 0) return "—";
  const h = Math.floor(m/60);
  const mm = m%60;
  if(h<=0) return `${mm}分`;
  if(mm===0) return `${h}時間`;
  return `${h}時間${mm}分`;
}

function remainingSlots(r){ return Math.max(0, (r.slotsTotal|0) - (r.joinedCount|0)); }
function computeClosed(r){
  const now = Date.now();
  const deadline = toMs(r.deadlineAt);
  if(r.closed) return true;
  if(deadline && now > deadline) return true;
  if(remainingSlots(r) <= 0) return true;
  return false;
}
function escapeHtml(str){
  return String(str)
    .replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;")
    .replaceAll('"',"&quot;").replaceAll("'","&#39;");
}
function escapeAttr(str){
  // attribute用（最低限）
  return escapeHtml(str).replaceAll("`","&#96;");
}
function sanitizeName(s){
  const t = String(s||"").trim().replace(/\s+/g," ").replace(/[\u0000-\u001f\u007f]/g,"");
  return t.slice(0,20);
}

/* ★4桁キー */
function is4DigitNumber(s){ return /^\d{4}$/.test(String(s||"").trim()); }
async function sha256Hex(text){
  const enc = new TextEncoder().encode(text);
  const buf = await crypto.subtle.digest("SHA-256", enc);
  return [...new Uint8Array(buf)].map(b => b.toString(16).padStart(2,"0")).join("");
}

/* ★数字以外を除去（4桁入力UX） */
function enforce4DigitNumeric(el){
  if(!el) return;
  el.addEventListener("input", ()=>{
    el.value = String(el.value||"").replace(/\D/g,"").slice(0,4);
  });
}
enforce4DigitNumeric($("delKey"));
enforce4DigitNumeric($("ekKey"));

/* ★コピー */
async function copyText(text, btn){
  try{
    await navigator.clipboard.writeText(text);
    if(btn){
      const prev = btn.textContent;
      btn.textContent = "コピー済";
      setTimeout(()=>btn.textContent = prev, 800);
    }
  }catch{
    alert("コピーに失敗しました。手動で選択してコピーしてください。");
  }
}

/* ===== state ===== */
let latestRooms = [];
let mineOnly = false;

/* ===== render ===== */
function render(){
  let rooms = [...latestRooms];

  if(mineOnly && currentUid){
    rooms = rooms.filter(r => r.creatorUid === currentUid);
  }

  const q = ($("q").value || "").trim().toLowerCase();
  if(q){
    rooms = rooms.filter(r=>{
      const hay = `${r.id || ""} ${r.creatorName||""} ${r.comment||""}`.toLowerCase();
      return hay.includes(q);
    });
  }

  const f = $("filterStatus").value;
  if(f==="open") rooms = rooms.filter(r=>!computeClosed(r));
  if(f==="closed") rooms = rooms.filter(r=>computeClosed(r));

  if(rooms.length===0){
    list.innerHTML = `<div class="empty">表示できる部屋がありません。<br><span class="small">「部屋を作成」から募集を作れます。</span></div>`;
    return;
  }

  list.innerHTML = rooms.map(r=>{
    const closed = computeClosed(r);
    const rem = remainingSlots(r);
    const statusText = closed ? "締切済み / 満員" : "募集中";
    const statusClass = closed ? "closed" : "open";

    const now = Date.now();
    const dl = toMs(r.deadlineAt);

    const dlText = !dl ? "締切：未設定"
      : now > dl ? "締切：過ぎています"
      : (()=> {
          const mins = Math.ceil((dl - now)/60000);
          const h = Math.floor(mins/60);
          const m = mins%60;
          return `締切：あと ${h>0?`${h}時間`:""}${m}分`;
        })();

    const comment = (r.comment||"").trim() || "（ひとこと未設定）";
    const durationText = formatDurationMinutes(r.durationMinutes);
    const endAtText = safeTsLabel(r.endAt);
    const timeRange = `${safeTsLabel(r.eventAt)} 〜 ${endAtText}`;

    const isMine = (currentUid && r.creatorUid === currentUid);
    const roomId = r.id || "";

    return `
      <div class="card ${isMine ? "mine" : ""}">
        <div class="top">
          <div class="id">
            <span>部屋ID：</span>
            <span class="kbd">${escapeHtml(roomId) || "—"}</span>
            <button class="copy" type="button" data-act="copyId" data-id="${escapeAttr(roomId)}">コピー</button>
            ${isMine ? `<span class="small" style="margin-left:4px; font-weight:1000; color:#2b4a62">あなたの部屋</span>` : ""}
          </div>
          <div class="status ${statusClass}">${statusText}</div>
        </div>

        <div class="meta">
          <div><b>作成者：</b>${escapeHtml(r.creatorName||"")}</div>
          <div><b>形式：</b>${escapeHtml(r.rule||"")}　<b>利用時間：</b>${escapeHtml(durationText)}</div>
          <div><b>時間：</b>${escapeHtml(timeRange)}</div>
          <hr class="sep">
          <div><b>募集：</b>${r.slotsTotal ?? "—"}名　<b>参加：</b>${r.joinedCount ?? 0}名　<b>残り：</b>${rem}名</div>
          <div class="small">${escapeHtml(safeTsLabel(r.deadlineAt))}（${escapeHtml(dlText)}）</div>
        </div>

        <div class="comment ${isMine ? "blue" : ""}">${escapeHtml(comment)}</div>

        <div class="actions">
          ${closed ? "" : `<button class="smallbtn join" data-act="joinFlow" data-id="${escapeAttr(roomId)}">参加する</button>`}
          <a class="smallbtn ask" href="mahjong-room-chat.html?id=${encodeURIComponent(roomId)}&ask=1">質問する</a>
          <a class="smallbtn" href="mahjong-room-chat.html?id=${encodeURIComponent(roomId)}">チャットを見る</a>

          <button class="smallbtn" data-act="cancel" data-id="${escapeAttr(roomId)}">キャンセル（-1）</button>
          ${isMine ? `<button class="smallbtn" data-act="edit" data-id="${escapeAttr(roomId)}">編集</button>` : ""}
          ${isMine ? `<button class="smallbtn danger" data-act="deleteKey" data-id="${escapeAttr(roomId)}">削除（キー）</button>` : ""}
        </div>

        <div class="small">※質問は「質問する」から。参加表明は「参加する」からお願いします。</div>
      </div>
    `;
  }).join("");
}

/* ===== join/cancel transaction ===== */
async function txUpdateCount(roomId, delta){
  if(!currentUid){ alert("認証中です。"); return false; }
  if(!roomId){ alert("部屋IDが不正です。"); return false; }

  const ref = doc(db, "rooms", roomId);
  try{
    await runTransaction(db, async (tx)=>{
      const snap = await tx.get(ref);
      if(!snap.exists()) throw new Error("room_not_found");
      const r = snap.data();

      const now = Date.now();
      const dl = toMs(r.deadlineAt);
      const rem = Math.max(0, (r.slotsTotal|0) - (r.joinedCount|0));
      const closed = r.closed || (dl ? now > dl : false) || rem <= 0;
      if(delta > 0 && closed) throw new Error("closed");

      let next = (r.joinedCount|0) + delta;
      if(next < 0) next = 0;
      if(next > (r.slotsTotal|0)) next = (r.slotsTotal|0);

      const nextClosed = (dl ? (now > dl) : false) || (Math.max(0, (r.slotsTotal|0) - next) <= 0);
      tx.update(ref, { joinedCount: next, closed: nextClosed });
    });
    return true;
  }catch(e){
    console.error(e);
    if(String(e.message).includes("closed")) alert("この部屋は締切済みです。");
    else alert("更新に失敗しました。");
    return false;
  }
}

/* ===== delete by key ===== */
async function deleteRoomWithKey(roomId, key){
  if(!currentUid){ alert("認証中です。"); return; }
  if(!roomId){ alert("部屋IDを入力してください。"); return; }
  if(!is4DigitNumber(key)){ alert("削除キーは4桁の数字で入力してください。"); return; }

  const ref = doc(db, "rooms", roomId);

  try{
    const snap = await getDoc(ref);
    if(!snap.exists()){ alert("部屋が見つかりません。部屋IDをご確認ください。"); return; }

    const data = snap.data() || {};
    if(!data.deleteKeyHash){
      alert("この部屋は削除キー未対応（deleteKeyHash未登録）です。");
      return;
    }

    const hash = await sha256Hex(key);
    if(hash !== data.deleteKeyHash){
      alert("削除キーが違います。");
      return;
    }

    const ok = confirm(`本当に削除しますか？\n\n部屋ID：${roomId}\n※削除は取り消せません。`);
    if(!ok) return;

    await deleteDoc(ref);
    alert("部屋を削除しました。");

    if($("delRoomId")) $("delRoomId").value = "";
    if($("delKey")) $("delKey").value = "";
  }catch(e){
    console.error(e);
    alert("削除に失敗しました。Firestoreルール/権限を確認してください。");
  }
}

/* ===== join name modal ===== */
let joinTargetRoomId = null;

function openJoinNameModal(roomId){
  joinTargetRoomId = roomId;
  const saved = localStorage.getItem("potoro_display_name") || "";
  $("jnName").value = saved;
  $("joinNameModal").style.display = "flex";
  setTimeout(()=>$("jnName").focus(), 30);
}
function closeJoinNameModal(){
  $("joinNameModal").style.display = "none";
  joinTargetRoomId = null;
}

$("jnClose").addEventListener("click", closeJoinNameModal);
$("jnCancel").addEventListener("click", closeJoinNameModal);
$("joinNameModal").addEventListener("click", (e)=>{ if(e.target === $("joinNameModal")) closeJoinNameModal(); });

$("jnOk").addEventListener("click", async ()=>{
  if(!joinTargetRoomId) return;
  const name = sanitizeName($("jnName").value);
  if(!name){
    alert("表示名を入力してください（20文字以内）。");
    return;
  }
  localStorage.setItem("potoro_display_name", name);

  // 先に参加数を +1（失敗したら遷移しない）
  const ok = await txUpdateCount(joinTargetRoomId, +1);
  if(!ok) return;

  // joinモードでチャットへ（入室メッセージはチャット側で処理）
  location.href = `mahjong-room-chat.html?id=${encodeURIComponent(joinTargetRoomId)}&joined=1&name=${encodeURIComponent(name)}`;
});

/* ===== edit key modal ===== */
let editTargetRoomId = null;

function openEditKeyModal(roomId){
  editTargetRoomId = roomId;
  $("ekRoomId").value = roomId;
  $("ekKey").value = "";
  $("editKeyModal").style.display = "flex";
  setTimeout(()=>$("ekKey").focus(), 30);
}
function closeEditKeyModal(){
  $("editKeyModal").style.display = "none";
  editTargetRoomId = null;
  $("ekKey").value = "";
}
$("ekClose").addEventListener("click", closeEditKeyModal);
$("ekCancel").addEventListener("click", closeEditKeyModal);
$("ekClear").addEventListener("click", ()=>{ $("ekKey").value=""; $("ekKey").focus(); });
$("editKeyModal").addEventListener("click", (e)=>{ if(e.target === $("editKeyModal")) closeEditKeyModal(); });
$("ekKey").addEventListener("keydown", (e)=>{
  if(e.key === "Enter"){
    e.preventDefault();
    $("ekOk").click();
  }
});

async function verifyEditKeyAndGo(roomId, key){
  if(!currentUid){ alert("認証中です。"); return; }
  if(!roomId){ alert("部屋IDが不正です。"); return; }
  if(!is4DigitNumber(key)){ alert("削除キーは4桁の数字で入力してください。"); return; }

  const ref = doc(db, "rooms", roomId);
  try{
    const snap = await getDoc(ref);
    if(!snap.exists()){ alert("部屋が見つかりません。"); return; }

    const data = snap.data() || {};
    if(!data.deleteKeyHash){
      alert("この部屋は削除キー未対応（deleteKeyHash未登録）です。編集できません。");
      return;
    }

    const hash = await sha256Hex(key);
    if(hash !== data.deleteKeyHash){
      alert("削除キーが違います。");
      return;
    }

    // ★キーをURLに載せず、編集許可だけを sessionStorage に保存
    const token = await sha256Hex(`${roomId}:${hash}:${Date.now()}`);
    sessionStorage.setItem(`potoro_edit_ok:${roomId}`, JSON.stringify({
      ok: true,
      at: Date.now(),
      token
    }));

    closeEditKeyModal();

    // ★編集ページへ
    location.href = `mahjong-room-edit.html?id=${encodeURIComponent(roomId)}`;
  }catch(e){
    console.error(e);
    alert("照合に失敗しました。Firestoreルール/権限を確認してください。");
  }
}

$("ekOk").addEventListener("click", async ()=>{
  if(!editTargetRoomId) return;
  const key = $("ekKey").value.trim();
  await verifyEditKeyAndGo(editTargetRoomId, key);
});

/* ===== list events ===== */
list.addEventListener("click", async (ev)=>{
  const btn = ev.target.closest("[data-act]");
  if(!btn) return;
  const act = btn.dataset.act;
  const roomId = btn.dataset.id || "";

  if(act==="copyId"){
    if(roomId) await copyText(roomId, btn);
    return;
  }

  if(act==="joinFlow"){
    openJoinNameModal(roomId);
    return;
  }
  if(act==="cancel") {
    if(confirm("参加数を -1 しますか？")) txUpdateCount(roomId, -1);
    return;
  }

  if(act==="edit"){
    openEditKeyModal(roomId);
    return;
  }

  if(act==="deleteKey"){
    $("delRoomId").value = roomId;
    $("delKey").focus();
    alert("削除は上部の「部屋の削除（4桁削除キー）」から行ってください。\n部屋IDを入力しました。");
    return;
  }
});

/* toolbar */
$("filterStatus").addEventListener("change", render);
$("q").addEventListener("input", render);

/* ★更新ボタン：確実な更新＝リロード */
$("btnRefresh").addEventListener("click", ()=>location.reload());

$("mineOnly").addEventListener("click", ()=>{
  mineOnly = !mineOnly;
  $("mineOnly").classList.toggle("on", mineOnly);
  $("mineOnly").setAttribute("aria-pressed", mineOnly ? "true" : "false");
  render();
});

/* delete bar */
$("btnDeleteByKey").addEventListener("click", async ()=>{
  const roomId = $("delRoomId").value.trim();
  const key = $("delKey").value.trim();
  await deleteRoomWithKey(roomId, key);
});
$("delKey").addEventListener("keydown", (e)=>{
  if(e.key === "Enter"){
    e.preventDefault();
    $("btnDeleteByKey").click();
  }
});

/* realtime (auth完了後に開始) */
function startRoomsListener(){
  const qRooms = query(collection(db, "rooms"), orderBy("eventAt", "asc"));
  unsubscribeRooms = onSnapshot(qRooms, (snap)=>{
    // ★最重要：必ず doc.id を r.id として持つ
    latestRooms = snap.docs.map(d=>{
      const data = d.data() || {};
      return { ...data, id: d.id };
    });
    render();
  }, (err)=>{
    console.error(err);
    list.innerHTML = `<div class="empty">読み込みに失敗しました。<br><span class="small">Firestore ルール（read）/ 認証状態をご確認ください。</span></div>`;
  });
}
</script>
</body>
</html>
