<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>PO・TORO｜面子募集の部屋を見る</title>
<meta name="description" content="麻雀 面子募集 部屋一覧ページ" />
<meta name="theme-color" content="#f6b7d2" />
<style>
:root{
  --bg:#fff7fb; --card:#fff; --ink:#2b2b2b; --sub:#666;
  --accent:#ff79a6; --accent2:#7fc9ff; --ring:#ffd7e6;
  --radius:20px; --shadow:0 12px 28px rgba(0,0,0,.08);
  --danger:#ff5b6a; --ok:#2ecc71; --muted:#999;
}
*{box-sizing:border-box}
body{
  margin:0; font-family:"Hiragino Kaku Gothic ProN","Noto Sans JP",system-ui;
  background:
    radial-gradient(1200px 600px at 15% 10%, rgba(255,121,166,.18), transparent 55%),
    radial-gradient(900px 500px at 85% 20%, rgba(127,201,255,.20), transparent 60%),
    linear-gradient(180deg,var(--bg),#fff 60%);
  color:var(--ink);
}
.wrap{max-width:980px;margin:0 auto;padding:20px}
header{display:flex;justify-content:space-between;align-items:flex-end;gap:12px;margin-bottom:14px}
h1{margin:0;font-size:22px}
.sub{font-size:13px;color:var(--sub);margin-top:6px;line-height:1.5}
.badge{
  font-size:12px;padding:7px 10px;border-radius:999px;background:rgba(255,255,255,.7);
  border:1px solid rgba(255,121,166,.22); color:#b34a6a; white-space:nowrap;
}
.toolbar{
  display:flex; gap:10px; flex-wrap:wrap;
  background:rgba(255,255,255,.82); border:1px solid var(--ring);
  border-radius:20px; padding:12px; box-shadow:var(--shadow); margin-bottom:14px;
}
.toolbar > *{flex:0 0 auto}
select,input{
  padding:10px 12px; border-radius:14px; border:1px solid #ddd; font-size:14px; font-family:inherit; background:#fff;
}
.btn{
  padding:10px 12px; border-radius:14px; border:1px solid rgba(255,121,166,.25);
  background:#fff; font-weight:900; cursor:pointer;
}
.btn.primary{
  border:none; color:#fff; background:linear-gradient(135deg,var(--accent),var(--accent2));
}
.grid{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:12px}
@media (max-width:820px){.grid{grid-template-columns:1fr}}
.card{
  background:rgba(255,255,255,.9);
  border:1px solid rgba(0,0,0,.06);
  border-radius:22px;
  padding:14px;
  box-shadow:0 10px 22px rgba(0,0,0,.06);
}
.top{display:flex;justify-content:space-between;gap:10px;align-items:flex-start}
.id{font-weight:1000; letter-spacing:.02em; font-size:13px}
.status{
  font-size:12px; font-weight:900; padding:7px 10px; border-radius:999px;
  border:1px solid rgba(0,0,0,.06); background:#fff;
}
.status.open{color:#0d7a33;border-color:rgba(46,204,113,.35);background:rgba(46,204,113,.08)}
.status.closed{color:#a51d2c;border-color:rgba(255,91,106,.35);background:rgba(255,91,106,.10)}
.meta{margin-top:8px;font-size:13px;color:var(--sub);line-height:1.6}
.meta b{color:var(--ink)}
.comment{
  margin-top:10px; padding:10px 12px; border-radius:16px;
  background:rgba(255,121,166,.06); border:1px solid rgba(255,121,166,.15);
  font-size:13px; line-height:1.6;
}
.actions{display:flex;gap:8px;flex-wrap:wrap;margin-top:12px}
.smallbtn{
  padding:9px 10px; border-radius:14px; border:1px solid rgba(0,0,0,.08);
  background:#fff; font-weight:900; cursor:pointer; font-size:13px;
}
.smallbtn.join{border:none;color:#fff;background:linear-gradient(135deg,var(--accent),var(--accent2))}
.smallbtn.danger{border-color:rgba(255,91,106,.35);color:#a51d2c;background:rgba(255,91,106,.08)}
.small{font-size:12px;color:var(--muted)}
.empty{
  padding:16px; border-radius:22px; border:1px dashed rgba(0,0,0,.18);
  background:rgba(255,255,255,.7); color:#666; text-align:center;
}
.back{margin-top:16px;text-align:center}
.back a{font-size:13px;color:#888;text-decoration:none}
</style>
</head>
<body>
<div class="wrap">
  <header>
    <div>
      <h1>面子募集の部屋を見る</h1>
      <div class="sub">締切・残り人数は自動更新されます（参加操作で残り計算）</div>
    </div>
    <div class="badge">PO・TORO / Mahjong</div>
  </header>

  <div class="toolbar">
    <select id="filterStatus" onchange="render()">
      <option value="all">すべて</option>
      <option value="open">募集中のみ</option>
      <option value="closed">締切済みのみ</option>
    </select>

    <select id="sortBy" onchange="render()">
      <option value="eventAsc">開催日時：近い順</option>
      <option value="eventDesc">開催日時：遠い順</option>
      <option value="createdDesc">作成：新しい順</option>
      <option value="createdAsc">作成：古い順</option>
    </select>

    <input id="q" type="text" placeholder="検索（作成者名 / ID / ひとこと）" oninput="render()" />

    <button class="btn" type="button" onclick="refresh()">更新</button>
    <button class="btn primary" type="button" onclick="location.href='mahjong-room-create.html'">部屋を作成</button>
  </div>

  <div id="list" class="grid"></div>

  <div class="back">
    <a href="mahjong-lobby.html">← 面子募集トップへ戻る</a>
  </div>
</div>

<script>
const STORAGE_KEY = "potoro_mahjong_rooms_v1";

function loadRooms(){
  try{ return JSON.parse(localStorage.getItem(STORAGE_KEY) || "[]"); }
  catch(e){ return []; }
}
function saveRooms(rooms){
  localStorage.setItem(STORAGE_KEY, JSON.stringify(rooms));
}

function pad(n){ return String(n).padStart(2,"0"); }
function isoToLabel(iso){
  const d = new Date(iso);
  const w = ["日","月","火","水","木","金","土"][d.getDay()];
  return `${d.getFullYear()}/${pad(d.getMonth()+1)}/${pad(d.getDate())}(${w}) ${pad(d.getHours())}:${pad(d.getMinutes())}`;
}

function computeClosed(room){
  const now = Date.now();
  const deadline = new Date(room.deadlineAt).getTime();
  const remaining = Math.max(0, (room.slotsTotal|0) - (room.joinedCount|0));
  if(room.closed) return true;
  if(now > deadline) return true;           // 締切超過
  if(remaining <= 0) return true;           // 満員
  return false;
}

function remainingSlots(room){
  return Math.max(0, (room.slotsTotal|0) - (room.joinedCount|0));
}

function normalizeRooms(rooms){
  // 過去データ互換＆締切・満員で自動クローズ反映
  let changed = false;
  for(const r of rooms){
    if(typeof r.joinedCount !== "number"){ r.joinedCount = 0; changed = true; }
    if(typeof r.closed !== "boolean"){ r.closed = false; changed = true; }
    const shouldClose = computeClosed(r);
    if(shouldClose && !r.closed){ r.closed = true; changed = true; }
  }
  if(changed) saveRooms(rooms);
  return rooms;
}

function join(roomId){
  const rooms = normalizeRooms(loadRooms());
  const r = rooms.find(x=>x.id===roomId);
  if(!r) return;

  // 最新の締切判定
  if(computeClosed(r)){
    r.closed = true;
    saveRooms(rooms);
    render();
    alert("この部屋は締切済みです。");
    return;
  }

  r.joinedCount = (r.joinedCount|0) + 1;

  // 満員ならクローズ
  if(remainingSlots(r) <= 0) r.closed = true;

  saveRooms(rooms);
  render();
}

function cancel(roomId){
  const rooms = normalizeRooms(loadRooms());
  const r = rooms.find(x=>x.id===roomId);
  if(!r) return;

  const current = (r.joinedCount|0);
  if(current <= 0) return;

  r.joinedCount = current - 1;

  // 締切を過ぎていなければ、空きができたら再オープン可（仕様）
  const now = Date.now();
  const deadline = new Date(r.deadlineAt).getTime();
  if(now <= deadline && remainingSlots(r) > 0){
    r.closed = false;
  }

  saveRooms(rooms);
  render();
}

function removeRoom(roomId){
  if(!confirm("この部屋を削除しますか？")) return;
  const rooms = normalizeRooms(loadRooms()).filter(r=>r.id!==roomId);
  saveRooms(rooms);
  render();
}

function refresh(){
  render(true);
}

function render(forceNormalize=false){
  let rooms = loadRooms();
  if(forceNormalize) rooms = normalizeRooms(rooms);
  else rooms = normalizeRooms(rooms);

  // 検索
  const q = (document.getElementById("q").value || "").trim().toLowerCase();
  if(q){
    rooms = rooms.filter(r=>{
      const hay = `${r.id} ${r.creator||""} ${r.comment||""}`.toLowerCase();
      return hay.includes(q);
    });
  }

  // ステータス絞り込み
  const f = document.getElementById("filterStatus").value;
  if(f === "open"){
    rooms = rooms.filter(r=>!computeClosed(r));
  }else if(f === "closed"){
    rooms = rooms.filter(r=>computeClosed(r));
  }

  // ソート
  const sortBy = document.getElementById("sortBy").value;
  const num = (v)=>new Date(v).getTime();
  rooms.sort((a,b)=>{
    if(sortBy==="eventAsc") return num(a.eventAt) - num(b.eventAt);
    if(sortBy==="eventDesc") return num(b.eventAt) - num(a.eventAt);
    if(sortBy==="createdAsc") return num(a.createdAt) - num(b.createdAt);
    return num(b.createdAt) - num(a.createdAt);
  });

  const list = document.getElementById("list");
  if(rooms.length===0){
    list.innerHTML = `<div class="empty">表示できる部屋がありません。<br><span class="small">「部屋を作成」から募集を作れます。</span></div>`;
    return;
  }

  list.innerHTML = rooms.map(r=>{
    const closed = computeClosed(r);
    const rem = remainingSlots(r);
    const total = r.slotsTotal|0;
    const joined = r.joinedCount|0;

    const statusText = closed ? "締切済み / 満員" : "募集中";
    const statusClass = closed ? "closed" : "open";

    // 締切まで
    const now = Date.now();
    const dl = new Date(r.deadlineAt).getTime();
    let dlText = "";
    if(now > dl){
      dlText = "締切：過ぎています";
    }else{
      const mins = Math.ceil((dl - now)/60000);
      const h = Math.floor(mins/60);
      const m = mins%60;
      dlText = `締切：あと ${h>0?`${h}時間`:""}${m}分`;
    }

    const comment = (r.comment||"").trim() || "（ひとこと未設定）";

    return `
      <div class="card">
        <div class="top">
          <div class="id">${escapeHtml(r.id)}</div>
          <div class="status ${statusClass}">${statusText}</div>
        </div>

        <div class="meta">
          <div><b>作成者：</b>${escapeHtml(r.creator||"")}</div>
          <div><b>開催：</b>${isoToLabel(r.eventAt)}　<b>形式：</b>${escapeHtml(r.rule||"")}</div>
          <div><b>募集：</b>${total}名　<b>参加：</b>${joined}名　<b>残り：</b>${rem}名</div>
          <div class="small">${isoToLabel(r.deadlineAt)}（${dlText}）</div>
        </div>

        <div class="comment">${escapeHtml(comment)}</div>

        <div class="actions">
          ${closed ? "" : `<button class="smallbtn join" onclick="join('${r.id}')">参加する（+1）</button>`}
          <button class="smallbtn" onclick="cancel('${r.id}')">キャンセル（-1）</button>
          <button class="smallbtn danger" onclick="removeRoom('${r.id}')">削除</button>
        </div>

        <div class="small">※締切超過 or 残り0で自動的に締切済みになります。</div>
      </div>
    `;
  }).join("");
}

function escapeHtml(str){
  return String(str)
    .replaceAll("&","&amp;")
    .replaceAll("<","&lt;")
    .replaceAll(">","&gt;")
    .replaceAll('"',"&quot;")
    .replaceAll("'","&#39;");
}

render();
</script>
</body>
</html>

