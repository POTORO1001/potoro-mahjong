<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>PO・TORO｜面子募集の部屋を見る</title>
<meta name="theme-color" content="#f6b7d2" />
<style>
:root{--bg:#fff7fb;--ink:#2b2b2b;--sub:#666;--accent:#ff79a6;--accent2:#7fc9ff;--ring:#ffd7e6;--shadow:0 12px 28px rgba(0,0,0,.08);--radius:22px;--danger:#ff5b6a}
*{box-sizing:border-box}
body{margin:0;font-family:"Hiragino Kaku Gothic ProN","Noto Sans JP",system-ui;background:linear-gradient(180deg,var(--bg),#fff);color:var(--ink)}
.wrap{max-width:980px;margin:0 auto;padding:20px}
header{display:flex;justify-content:space-between;align-items:flex-end;gap:12px;margin-bottom:14px}
h1{margin:0;font-size:22px}
.sub{font-size:13px;color:var(--sub);margin-top:6px;line-height:1.5}
.badge{font-size:12px;padding:7px 10px;border-radius:999px;background:rgba(255,255,255,.7);border:1px solid rgba(255,121,166,.22);color:#b34a6a;white-space:nowrap}
.toolbar{display:flex;gap:10px;flex-wrap:wrap;background:rgba(255,255,255,.9);border:1px solid var(--ring);border-radius:20px;padding:12px;box-shadow:var(--shadow);margin-bottom:14px}
select,input{padding:10px 12px;border-radius:14px;border:1px solid #ddd;font-size:14px;font-family:inherit;background:#fff}
.btn{padding:10px 12px;border-radius:14px;border:1px solid rgba(255,121,166,.25);background:#fff;font-weight:1000;cursor:pointer}
.btn.primary{border:none;color:#fff;background:linear-gradient(135deg,var(--accent),var(--accent2))}
.grid{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:12px}
@media (max-width:820px){.grid{grid-template-columns:1fr}}
.card{background:rgba(255,255,255,.92);border:1px solid rgba(0,0,0,.06);border-radius:var(--radius);padding:14px;box-shadow:0 10px 22px rgba(0,0,0,.06)}
.top{display:flex;justify-content:space-between;gap:10px;align-items:flex-start}
.id{font-weight:1000;font-size:13px;letter-spacing:.02em}
.status{font-size:12px;font-weight:1000;padding:7px 10px;border-radius:999px;border:1px solid rgba(0,0,0,.06);background:#fff}
.status.open{color:#0d7a33;border-color:rgba(46,204,113,.35);background:rgba(46,204,113,.08)}
.status.closed{color:#a51d2c;border-color:rgba(255,91,106,.35);background:rgba(255,91,106,.10)}
.meta{margin-top:8px;font-size:13px;color:var(--sub);line-height:1.7}
.meta b{color:var(--ink)}
.comment{margin-top:10px;padding:10px 12px;border-radius:16px;background:rgba(255,121,166,.06);border:1px solid rgba(255,121,166,.15);font-size:13px;line-height:1.6}
.actions{display:flex;gap:8px;flex-wrap:wrap;margin-top:12px}
.smallbtn{padding:9px 10px;border-radius:14px;border:1px solid rgba(0,0,0,.08);background:#fff;font-weight:1000;cursor:pointer;font-size:13px;text-decoration:none;display:inline-flex;align-items:center}
.smallbtn.join{border:none;color:#fff;background:linear-gradient(135deg,var(--accent),var(--accent2))}
.smallbtn.danger{border-color:rgba(255,91,106,.35);color:#a51d2c;background:rgba(255,91,106,.08)}
.small{font-size:12px;color:#999}
.empty{padding:16px;border-radius:22px;border:1px dashed rgba(0,0,0,.18);background:rgba(255,255,255,.7);color:#666;text-align:center}
.back{margin-top:16px;text-align:center}
.back a{font-size:13px;color:#888;text-decoration:none}
hr.sep{border:none;border-top:1px dashed rgba(0,0,0,.12);margin:10px 0}
</style>
</head>
<body>
<div class="wrap">
  <header>
    <div>
      <h1>面子募集の部屋を見る</h1>
      <div class="sub">利用時間（2〜5時間/30分刻み）・終了予定も表示します</div>
    </div>
    <div class="badge">PO・TORO / Mahjong</div>
  </header>

  <div class="toolbar">
    <select id="filterStatus">
      <option value="all">すべて</option>
      <option value="open">募集中のみ</option>
      <option value="closed">締切済みのみ</option>
    </select>

    <input id="q" type="text" placeholder="検索（作成者名 / ID / ひとこと）" />

    <button class="btn" type="button" id="btnRefresh">更新</button>
    <button class="btn primary" type="button" onclick="location.href='mahjong-room-create.html'">部屋を作成</button>
  </div>

  <div id="list" class="grid"></div>

  <div class="back">
    <a href="mahjong-lobby.html">← 面子募集トップへ戻る</a>
  </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";
import {
  getFirestore, collection, onSnapshot, query, orderBy,
  doc, runTransaction, deleteDoc
} from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

/** ここをFirebase Consoleの値に置換 */
const firebaseConfig = {
  apiKey: "AIzaSyXXXXXX",
  authDomain: "xxxx.firebaseapp.com",
  projectId: "xxxx",
  storageBucket: "xxxx.appspot.com",
  messagingSenderId: "123456789",
  appId: "1:123456:web:xxxx"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

let currentUid = null;
onAuthStateChanged(auth, (u)=>{ if(u) currentUid = u.uid; });
signInAnonymously(auth).catch(()=>alert("Firebase認証に失敗しました（Anonymous Authを有効化してください）"));

const $ = (id)=>document.getElementById(id);
const list = $("list");

function pad(n){ return String(n).padStart(2,"0"); }
function tsToLabel(ts){
  const d = ts.toDate();
  const w = ["日","月","火","水","木","金","土"][d.getDay()];
  return `${d.getFullYear()}/${pad(d.getMonth()+1)}/${pad(d.getDate())}(${w}) ${pad(d.getHours())}:${pad(d.getMinutes())}`;
}
function formatDurationMinutes(min){
  const m = Number(min);
  if(!Number.isFinite(m) || m <= 0) return "—";
  const h = Math.floor(m/60);
  const mm = m%60;
  return mm === 0 ? `${h}時間` : `${h}時間30分`;
}

function remainingSlots(r){ return Math.max(0, (r.slotsTotal|0) - (r.joinedCount|0)); }

function computeClosed(r){
  const now = Date.now();
  const deadline = r.deadlineAt?.toDate?.().getTime?.() ?? 0;
  if(r.closed) return true;
  if(now > deadline) return true;
  if(remainingSlots(r) <= 0) return true;
  return false;
}

function escapeHtml(str){
  return String(str)
    .replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;")
    .replaceAll('"',"&quot;").replaceAll("'","&#39;");
}

let latestRooms = [];

function render(){
  let rooms = [...latestRooms];

  const q = ($("q").value || "").trim().toLowerCase();
  if(q){
    rooms = rooms.filter(r=>{
      const hay = `${r.id} ${r.creatorName||""} ${r.comment||""}`.toLowerCase();
      return hay.includes(q);
    });
  }

  const f = $("filterStatus").value;
  if(f==="open") rooms = rooms.filter(r=>!computeClosed(r));
  if(f==="closed") rooms = rooms.filter(r=>computeClosed(r));

  if(rooms.length===0){
    list.innerHTML = `<div class="empty">表示できる部屋がありません。<br><span class="small">「部屋を作成」から募集を作れます。</span></div>`;
    return;
  }

  list.innerHTML = rooms.map(r=>{
    const closed = computeClosed(r);
    const rem = remainingSlots(r);
    const statusText = closed ? "締切済み / 満員" : "募集中";
    const statusClass = closed ? "closed" : "open";

    // 締切まで
    const now = Date.now();
    const dl = r.deadlineAt.toDate().getTime();
    const dlText = now > dl
      ? "締切：過ぎています"
      : (()=> {
          const mins = Math.ceil((dl - now)/60000);
          const h = Math.floor(mins/60);
          const m = mins%60;
          return `締切：あと ${h>0?`${h}時間`:""}${m}分`;
        })();

    const comment = (r.comment||"").trim() || "（ひとこと未設定）";

    const durationText = formatDurationMinutes(r.durationMinutes);
    const endAtText = r.endAt ? tsToLabel(r.endAt) : "—";

    // 開始〜終了の表示（視認性高め）
    const timeRange = `${tsToLabel(r.eventAt)} 〜 ${endAtText}`;

    return `
      <div class="card">
        <div class="top">
          <div class="id">${escapeHtml(r.id)}</div>
          <div class="status ${statusClass}">${statusText}</div>
        </div>

        <div class="meta">
          <div><b>作成者：</b>${escapeHtml(r.creatorName||"")}</div>
          <div><b>形式：</b>${escapeHtml(r.rule||"")}　<b>利用時間：</b>${escapeHtml(durationText)}</div>
          <div><b>時間：</b>${escapeHtml(timeRange)}</div>
          <hr class="sep">
          <div><b>募集：</b>${r.slotsTotal}名　<b>参加：</b>${r.joinedCount}名　<b>残り：</b>${rem}名</div>
          <div class="small">${tsToLabel(r.deadlineAt)}（${dlText}）</div>
        </div>

        <div class="comment">${escapeHtml(comment)}</div>

        <div class="actions">
          ${closed ? "" : `<button class="smallbtn join" data-act="join" data-id="${escapeHtml(r.id)}">参加する（+1）</button>`}
          <button class="smallbtn" data-act="cancel" data-id="${escapeHtml(r.id)}">キャンセル（-1）</button>
          <a class="smallbtn" href="mahjong-room-chat.html?id=${encodeURIComponent(r.id)}">チャットへ</a>
          ${r.creatorUid === currentUid ? `<button class="smallbtn danger" data-act="delete" data-id="${escapeHtml(r.id)}">削除</button>` : ""}
        </div>

        <div class="small">※締切超過 or 残り0で自動的に締切扱いになります。</div>
      </div>
    `;
  }).join("");
}

async function txUpdateCount(roomId, delta){
  if(!currentUid){ alert("認証中です。"); return; }

  const ref = doc(db, "rooms", roomId);
  try{
    await runTransaction(db, async (tx)=>{
      const snap = await tx.get(ref);
      if(!snap.exists()) throw new Error("room_not_found");
      const r = snap.data();

      // 締切/満員判定（トランザクション内で確定）
      const now = Date.now();
      const dl = r.deadlineAt.toDate().getTime();
      const rem = Math.max(0, (r.slotsTotal|0) - (r.joinedCount|0));
      const closed = r.closed || now > dl || rem <= 0;
      if(delta > 0 && closed) throw new Error("closed");

      let next = (r.joinedCount|0) + delta;
      if(next < 0) next = 0;
      if(next > r.slotsTotal) next = r.slotsTotal;

      const nextClosed = (now > dl) || (Math.max(0, r.slotsTotal - next) <= 0);

      tx.update(ref, { joinedCount: next, closed: nextClosed });
    });
  }catch(e){
    console.error(e);
    if(String(e.message).includes("closed")) alert("この部屋は締切済みです。");
    else alert("更新に失敗しました。");
  }
}

async function deleteRoom(roomId){
  if(!confirm("この部屋を削除しますか？（作成者のみ可能）")) return;
  try{
    await deleteDoc(doc(db, "rooms", roomId));
  }catch(e){
    console.error(e);
    alert("削除に失敗しました。");
  }
}

list.addEventListener("click", (ev)=>{
  const btn = ev.target.closest("[data-act]");
  if(!btn) return;
  const act = btn.dataset.act;
  const roomId = btn.dataset.id;
  if(act==="join") txUpdateCount(roomId, +1);
  if(act==="cancel") txUpdateCount(roomId, -1);
  if(act==="delete") deleteRoom(roomId);
});

$("filterStatus").addEventListener("change", render);
$("q").addEventListener("input", render);
$("btnRefresh").addEventListener("click", render);

// リアルタイム購読（開催日時昇順）
const qRooms = query(collection(db, "rooms"), orderBy("eventAt", "asc"));
onSnapshot(qRooms, (snap)=>{
  latestRooms = snap.docs.map(d=>d.data());
  render();
});
</script>
</body>
</html>
